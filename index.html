<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Preventivas de Máquinas — Grilazer (Admin)</title>

  <style>
    :root{
      --bg:#f3f5f8;
      --panel:#ffffff;
      --panel2:#fbfcfe;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --border2:#eef2f7;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;

      --shadow: 0 14px 35px rgba(15,23,42,.10);
      --shadow2: 0 10px 25px rgba(15,23,42,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.08), transparent 55%),
        linear-gradient(180deg, #f7f8fb, var(--bg));
      min-height:100dvh;
      padding:18px;
    }

    /* LOGIN */
    #login-screen{
      width:100%;
      min-height:calc(100dvh - 36px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .login-card{
      width:100%;
      max-width:420px;
      padding:18px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .login-card h1{margin:0;font-size:18px;font-weight:900}
    .login-card p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:700}
    .field input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .field input:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .btn{
      margin-top:8px;
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.65;cursor:wait}
    .login-error{margin-top:4px;font-size:12px;color:var(--err);min-height:14px}
    .login-foot{font-size:11px;color:var(--muted);margin-top:2px}

    /* APP */
    .wrap{width:100%;max-width:1200px;margin:0 auto}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow2);
      margin-bottom:14px;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:260px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(37,99,235,.12), rgba(37,99,235,.03));
      display:grid;place-items:center;
      font-weight:1000;
      letter-spacing:.2px;
      color:#0b2a7a;
    }
    .brand h1{margin:0;font-size:16px;font-weight:950;line-height:1.1}
    #userInfoTop{font-size:11px;color:var(--muted);margin-top:4px}

    .controls{
      display:flex;flex-wrap:wrap;justify-content:flex-end;
      gap:8px;align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      border-radius:12px;
      padding:9px 11px;
      font-weight:900;
      cursor:pointer;
      color:var(--text);
      background: #fff;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    button:hover{border-color:#cbd5e1;box-shadow: 0 8px 18px rgba(15,23,42,.08)}
    button:active{transform: translateY(1px)}
    .ghost{background:#fff}
    .primary{
      color:#fff;
      border-color: rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .ok{
      color:#fff;border-color: rgba(22,163,74,.25);
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    .warn{
      color:#fff;border-color: rgba(245,158,11,.25);
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    .err{
      color:#fff;border-color: rgba(239,68,68,.25);
      background: linear-gradient(135deg, #f87171, #ef4444);
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 380px 1fr;
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding:14px;
    }

    h3,h4{margin:0}
    h3{font-size:14px;font-weight:950}
    h4{font-size:13px;font-weight:900;color:var(--text);opacity:.95}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .sep{height:1px;background: var(--border2);margin:12px 0}

    label{
      display:block;
      font-weight:800;
      margin:10px 0 6px;
      color: rgba(15,23,42,.85);
      font-size:12px;
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:76px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #syncStatus{font-size:11px;color:var(--muted);margin-top:6px}

    /* TABS */
    .tabs{
      display:flex;
      gap:8px;
      border-bottom:1px solid var(--border2);
      padding-bottom:10px;
      margin-bottom:10px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:950;
      font-size:12px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .tab.active{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      color:#0b2a7a;
    }
    .pane{display:none}
    .pane.active{display:block}

    /* Lista máquinas */
    #listaEqp{
      margin-top:8px;
      max-height:280px;
      overflow:auto;
      padding-right:2px;
    }
    #listaEqp::-webkit-scrollbar{width:8px}
    #listaEqp::-webkit-scrollbar-thumb{background: rgba(15,23,42,.12);border-radius:999px}

    .chip-eqp{
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 10px;
      margin:8px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      font-size:12px;
      cursor:pointer;
      background: #fff;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
      gap:10px;
    }
    .chip-eqp:hover{background: #f8fafc; border-color:#cbd5e1}
    .chip-eqp:active{transform: translateY(1px)}
    .chip-eqp .title{font-weight:950}
    .chip-eqp .sub{color:var(--muted);margin-top:2px}
    .chip-eqp.active{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.35);
    }
    .chip-eqp button{
      padding:7px 10px;
      font-size:11px;
      border-radius:12px;
      white-space:nowrap;
      box-shadow:none;
    }
    .chip-eqp button:hover{box-shadow:none}

    /* Direita */
    .filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      background: #fff;
      border:1px solid var(--border);
      font-weight:900;
      font-size:11px;
      color: var(--muted);
    }

    .kpi{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      margin:10px 0 6px;
    }
    .kpi .card{
      padding:12px;
      border-radius:16px;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .kpi .big{
      font-size:22px;
      font-weight:1000;
      margin-top:4px;
      letter-spacing:.2px;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      margin-top:8px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th,.table td{
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:top;
      border-bottom:1px solid var(--border2);
    }
    .table th{
      background: #f8fafc;
      color: rgba(15,23,42,.75);
      font-size:12px;
      letter-spacing:.2px;
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{border-bottom:none}

    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:11px;
      letter-spacing:.2px;
      border:1px solid var(--border);
      background:#fff;
    }
    .b-ok{background: #ecfdf5; color:#166534; border-color:#86efac}
    .b-warn{background:#fffbeb; color:#92400e; border-color:#fde68a}
    .b-err{background:#fef2f2; color:#991b1b; border-color:#fecaca}

    .foot{
      margin-top:12px;
      color:rgba(100,116,139,.9);
      text-align:center;
      font-size:12px;
    }

    /* MODAL QR */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index: 9999;
    }
    .modal.show{display:flex}
    .modal-card{
      width:min(560px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--border2);
      background: linear-gradient(180deg, #fff, #fbfcff);
    }
    .modal-title{font-weight:950;font-size:13px}
    .modal-body{padding:12px}
    #qr-reader{
      width:100%;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#0b1220;
      min-height: 280px;
    }
    .modal-foot{
      display:flex;
      gap:8px;
      padding:12px;
      border-top:1px solid var(--border2);
      justify-content:flex-end;
      background:#fff;
    }
    .qr-help{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    @media (max-width: 980px){
      body{padding:12px}
      .grid{grid-template-columns:1fr}
      .controls{justify-content:flex-start}
    }
    @media print{
      body{background:#fff;color:#000;padding:0}
      #login-screen{display:none !important}
      .controls{display:none !important}
      .card,.topbar{box-shadow:none !important}
      .table{background:#fff}
      .modal{display:none !important}
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>

  <!-- LOGIN -->
  <section id="login-screen">
    <div class="login-card">
      <h1>Preventivas — Admin</h1>
      <p>Acesso restrito. Faça login com seu e-mail corporativo autorizado.</p>

      <div class="field">
        <label for="loginEmail">E-mail</label>
        <input type="email" id="loginEmail" autocomplete="email" placeholder="engenhariagrilazer@gmail.com">
      </div>

      <div class="field">
        <label for="loginSenha">Senha</label>
        <input type="password" id="loginSenha" autocomplete="current-password" placeholder="••••••••">
      </div>

      <button class="btn" id="btnLogin">Entrar</button>
      <div class="login-error" id="loginError"></div>

      <div class="login-foot">
        Usuários válidos são gerenciados no Firebase Authentication (E-mail/Senha).
      </div>
    </div>
  </section>

  <!-- APP -->
  <div class="wrap" id="app-wrap" style="display:none">

    <div class="topbar">
      <div class="brand">
        <div class="logo">GR</div>
        <div>
          <h1>Preventivas de Máquinas — Grilazer</h1>
          <div id="userInfoTop"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ghost" id="btnNovoEqp" type="button">Novo</button>
        <button class="ghost" id="btnOpenQrTop" type="button">Ler QR</button>
        <button class="ghost" type="button" onclick="window.print()">Imprimir</button>
        <button class="ghost" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="grid">
      <!-- ESQUERDA (ABAS) -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabMaquinas" type="button">Máquinas</button>
          <button class="tab" id="tabTarefas" type="button">Tarefas</button>
        </div>

        <!-- PANE MÁQUINAS -->
        <div class="pane active" id="paneMaquinas">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h3>Cadastro de Máquina</h3>
              <div class="muted" id="infoEqpSel">Nenhuma máquina selecionada.</div>
              <div id="syncStatus">Sincronização: carregando…</div>
            </div>
            <button class="ghost" id="btnScanQrMachine" type="button">Ler QR</button>
          </div>

          <label for="eqNome">Nome da máquina</label>
          <input id="eqNome" placeholder="Ex.: Prensa Hidráulica 30T">

          <label for="eqLocal">Localização</label>
          <input id="eqLocal" placeholder="Ex.: Metalúrgica, Setor A">

          <label for="eqSerie">Nº de Série / Patrimônio</label>
          <input id="eqSerie" placeholder="Ex.: SER-000123 / PAT-045">

          <label for="eqQr">Código (QR Code)</label>
          <input id="eqQr" placeholder="Ex.: QR-PR30T-001 (texto dentro do QR)">

          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnSalvarEqp" type="button">Salvar</button>
            <button class="ghost" id="btnLimparEqp" type="button">Limpar</button>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h4>Máquinas cadastradas</h4>
            <span class="muted">Clique para selecionar</span>
          </div>

          <div id="listaEqp"></div>
        </div>

        <!-- PANE TAREFAS -->
        <div class="pane" id="paneTarefas">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h3>Cadastro de Tarefa</h3>
              <div class="muted">Selecione a máquina ou leia o QR</div>
            </div>
            <button class="ghost" id="btnScanQrTask" type="button">Ler QR</button>
          </div>

          <label for="selEqpTarefa">Máquina</label>
          <select id="selEqpTarefa"></select>
          <div class="muted" id="hintEqpTarefa" style="margin-top:6px"></div>

          <label for="tkTitulo">Título da tarefa</label>
          <input id="tkTitulo" placeholder="Ex.: Lubrificar guias e mancais">

          <div class="row">
            <div style="flex:1;min-width:140px">
              <label for="tkPeriodo">Periodicidade</label>
              <select id="tkPeriodo">
                <option value="30">30 dias</option>
                <option value="90">90 dias</option>
                <option value="180">180 dias</option>
                <option value="360">360 dias</option>
              </select>
            </div>

            <div style="flex:1;min-width:140px">
              <label for="tkUltima">Última execução</label>
              <input id="tkUltima" type="date">
            </div>
          </div>

          <label for="tkObs">Observações</label>
          <textarea id="tkObs" placeholder="Materiais, torque, check-list, segurança, etc."></textarea>

          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnAddTarefa" type="button">Adicionar</button>
            <button class="ghost" id="btnLimparTarefa" type="button">Limpar</button>
          </div>

          <div class="muted" style="margin-top:6px">
            Dica: se nunca foi feita, deixe a última execução em branco — a próxima será calculada a partir de hoje.
          </div>
        </div>
      </div>

      <!-- DIREITA (VISÃO GERAL) -->
      <div class="card">
        <div class="filters">
          <input id="busca" placeholder="Buscar por máquina/tarefa…" style="flex:1;min-width:220px">
          <span class="pill">Hoje: <span id="today"></span></span>
          <select id="selFiltro">
            <option value="todos">Todos</option>
            <option value="atrasadas">Atrasadas</option>
            <option value="sete">Próx. 7 dias</option>
            <option value="trinta">Próx. 30 dias</option>
          </select>
        </div>

        <div class="kpi">
          <div class="card">
            <div class="muted">Atrasadas</div>
            <div class="big" id="kpiAtr">0</div>
          </div>
          <div class="card">
            <div class="muted">Até 7 dias</div>
            <div class="big" id="kpi7">0</div>
          </div>
          <div class="card">
            <div class="muted">Até 30 dias</div>
            <div class="big" id="kpi30">0</div>
          </div>
          <div class="card">
            <div class="muted">Total tarefas</div>
            <div class="big" id="kpiTot">0</div>
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Máquina</th>
              <th>Tarefa</th>
              <th>Período</th>
              <th>Última</th>
              <th>Próxima</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="foot">Grilazer — Preventivas</div>
  </div>

  <!-- MODAL QR -->
  <div class="modal" id="qrModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="qrModalTitle">Ler QR Code</div>
        <button class="ghost" id="btnCloseQr" type="button">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="muted" id="qrHint" style="margin-bottom:8px">
          Aponte a câmera para o QR da máquina.
        </div>
        <div id="qr-reader"></div>
        <div class="qr-help" id="qrHelp"></div>
      </div>
      <div class="modal-foot">
        <button class="ghost" id="btnSwitchCamera" type="button">Trocar câmera</button>
        <button class="err" id="btnStopQr" type="button">Parar</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // FIREBASE CONFIG
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDNrOyDmI5NOkVuG3yh8HkDrn4dqYXOrW0",
    authDomain: "preventivas-27185.firebaseapp.com",
    databaseURL: "https://preventivas-27185-default-rtdb.firebaseio.com",
    projectId: "preventivas-27185",
    storageBucket: "preventivas-27185.firebasestorage.app",
    messagingSenderId: "862235462324",
    appId: "1:862235462324:web:bcf4948b6b5bb96cbee5e1",
    measurementId: "G-8D16CFDLZV"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  const DB_PATH = "preventivas_grilazer";

  // E-mails autorizados
  const allowedEmails = [
    "engenhariagrilazer@gmail.com"
  ];

  // =========================
  // ELEMENTOS LOGIN
  // =========================
  const loginScreen   = document.getElementById('login-screen');
  const appWrap       = document.getElementById('app-wrap');
  const loginEmail    = document.getElementById('loginEmail');
  const loginSenha    = document.getElementById('loginSenha');
  const btnLogin      = document.getElementById('btnLogin');
  const loginError    = document.getElementById('loginError');
  const btnLogout     = document.getElementById('btnLogout');
  const userInfoTop   = document.getElementById('userInfoTop');

  function setLoginLoading(isLoading){
    btnLogin.disabled = isLoading;
    btnLogin.textContent = isLoading ? "Entrando..." : "Entrar";
  }
  function showLogin(){
    loginScreen.style.display = "flex";
    appWrap.style.display     = "none";
    loginError.textContent    = "";
    loginSenha.value          = "";
  }
  function showApp(user){
    loginScreen.style.display = "none";
    appWrap.style.display     = "block";
    userInfoTop.textContent   = "Logado como: " + user.email;
  }

  // =========================
  // HELPERS
  // =========================
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const addDays = (iso, n)=>{
    const d = iso? new Date(iso) : new Date();
    d.setHours(12,0,0,0);
    d.setDate(d.getDate()+n);
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  };
  const diffDays = (a,b)=> Math.floor((new Date(a)-new Date(b))/(1000*60*60*24));
  const fmtBR = (iso)=> iso? new Date(iso+'T00:00:00').toLocaleDateString('pt-BR') : '—';
  const uid = ()=> 'id-'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(4);

  // =========================
  // STORE
  // =========================
  let store = { equipamentos: [] };
  let selectedEqpId = null;
  let appInitialized = false;

  // =========================
  // ELEMENTOS APP
  // =========================
  const tabMaquinas = document.getElementById('tabMaquinas');
  const tabTarefas  = document.getElementById('tabTarefas');
  const paneMaquinas = document.getElementById('paneMaquinas');
  const paneTarefas  = document.getElementById('paneTarefas');

  const eqNome = document.getElementById('eqNome');
  const eqLocal = document.getElementById('eqLocal');
  const eqSerie = document.getElementById('eqSerie');
  const eqQr = document.getElementById('eqQr');
  const infoEqpSel = document.getElementById('infoEqpSel');
  const listaEqp = document.getElementById('listaEqp');
  const syncStatus = document.getElementById('syncStatus');

  const selEqpTarefa = document.getElementById('selEqpTarefa');
  const hintEqpTarefa = document.getElementById('hintEqpTarefa');

  const tkTitulo = document.getElementById('tkTitulo');
  const tkPeriodo = document.getElementById('tkPeriodo');
  const tkUltima = document.getElementById('tkUltima');
  const tkObs = document.getElementById('tkObs');

  const busca = document.getElementById('busca');
  const selFiltro = document.getElementById('selFiltro');
  const todaySpan = document.getElementById('today');

  const kpiAtr = document.getElementById('kpiAtr');
  const kpi7 = document.getElementById('kpi7');
  const kpi30 = document.getElementById('kpi30');
  const kpiTot = document.getElementById('kpiTot');
  const tbody = document.getElementById('tbody');

  const btnSalvarEqp = document.getElementById('btnSalvarEqp');
  const btnLimparEqp = document.getElementById('btnLimparEqp');
  const btnAddTarefa = document.getElementById('btnAddTarefa');
  const btnLimparTarefa = document.getElementById('btnLimparTarefa');
  const btnNovoEqp = document.getElementById('btnNovoEqp');

  const btnScanQrMachine = document.getElementById('btnScanQrMachine');
  const btnScanQrTask = document.getElementById('btnScanQrTask');
  const btnOpenQrTop = document.getElementById('btnOpenQrTop');

  // =========================
  // ABAS
  // =========================
  function openTab(which){
    const isM = which === 'maquinas';
    tabMaquinas.classList.toggle('active', isM);
    tabTarefas.classList.toggle('active', !isM);
    paneMaquinas.classList.toggle('active', isM);
    paneTarefas.classList.toggle('active', !isM);
  }

  // =========================
  // SYNC STATUS
  // =========================
  function setSyncStatus(text){
    syncStatus.textContent = "Sincronização: " + text;
  }

  // =========================
  // LOCAL STORAGE (backup)
  // =========================
  function loadLocal(){
    try{
      const raw = localStorage.getItem('preventivas');
      if(raw){ store = JSON.parse(raw); }
    }catch{}
  }
  function saveLocal(){
    try{ localStorage.setItem('preventivas', JSON.stringify(store)); }catch{}
  }

  // =========================
  // FIREBASE SAVE/LOAD
  // =========================
  function saveRemote(){
    setSyncStatus("enviando ao servidor…");
    db.ref(DB_PATH).set(store)
      .then(()=> setSyncStatus("ok (sincronizado)"))
      .catch(err=>{
        console.error(err);
        setSyncStatus("erro ao sincronizar (ver console)");
      });
  }
  function fullSave(){
    saveLocal();
    saveRemote();
  }

  function syncFromFirebaseOnce(){
    setSyncStatus("carregando do servidor…");
    db.ref(DB_PATH).once("value")
      .then(snapshot=>{
        const val = snapshot.val();
        if(val && Array.isArray(val.equipamentos)){
          store = val;
          saveLocal();
        }
      })
      .catch(err=>{
        console.error(err);
        setSyncStatus("erro ao carregar (usando dados locais)");
      })
      .finally(()=>{
        renderEqpList();
        renderEqpSelect();
        renderTabela();
        setSyncStatus("ok");
      });
  }

  // =========================
  // FORM: MÁQUINA
  // =========================
  function clearEqpForm(){
    selectedEqpId = null;
    eqNome.value  = '';
    eqLocal.value = '';
    eqSerie.value = '';
    eqQr.value    = '';
    infoEqpSel.textContent = 'Nenhuma máquina selecionada.';
    renderEqpList();
    renderEqpSelect();
    renderTabela();
  }

  function setSelectedEqp(eqp){
    if(!eqp){
      clearEqpForm();
      return;
    }
    selectedEqpId = eqp.id;
    eqNome.value  = eqp.nome;
    eqLocal.value = eqp.local || '';
    eqSerie.value = eqp.serie || '';
    eqQr.value    = eqp.qr || '';
    infoEqpSel.textContent = 'Editando: ' + eqp.nome;

    // sincroniza select tarefas
    renderEqpSelect();
    selEqpTarefa.value = eqp.id;
    hintEqpTarefa.textContent = buildEqpHint(eqp);

    renderEqpList();
    renderTabela();
  }

  function buildEqpHint(eqp){
    const parts = [];
    if(eqp.local) parts.push("Local: " + eqp.local);
    if(eqp.serie) parts.push("Patrimônio/Série: " + eqp.serie);
    if(eqp.qr) parts.push("QR: " + eqp.qr);
    return parts.join(" • ");
  }

  function addOrUpdateEquipamento(){
    const nome = eqNome.value.trim();
    if(!nome){ alert('Informe o nome da máquina'); return; }

    const local = eqLocal.value.trim();
    const serie = eqSerie.value.trim();
    const qr = eqQr.value.trim();

    // evitar QR duplicado
    if(qr){
      const dup = store.equipamentos.find(e => (e.qr||"").trim() === qr && e.id !== selectedEqpId);
      if(dup){
        alert('Este QR já está cadastrado na máquina: ' + dup.nome);
        return;
      }
    }

    if(selectedEqpId){
      const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
      if(eqp){
        eqp.nome = nome;
        eqp.local = local;
        eqp.serie = serie;
        eqp.qr = qr;
      }
    }else{
      const eqp = {
        id: uid(),
        nome,
        local,
        serie,
        qr,
        tarefas: []
      };
      store.equipamentos.push(eqp);
      selectedEqpId = eqp.id;
    }

    fullSave();
    setSelectedEqp(store.equipamentos.find(e=> e.id===selectedEqpId));
    renderEqpSelect();
  }

  // =========================
  // LISTA: MÁQUINAS
  // =========================
  function renderEqpList(){
    listaEqp.innerHTML = '';
    if(!store.equipamentos.length){
      listaEqp.innerHTML = '<div class="muted">Nenhuma máquina cadastrada ainda.</div>';
      return;
    }

    store.equipamentos.forEach(eqp=>{
      const div = document.createElement('div');
      div.className = 'chip-eqp' + (eqp.id===selectedEqpId ? ' active' : '');

      const left = document.createElement('div');
      const subParts = [];
      if(eqp.local) subParts.push(eqp.local);
      if(eqp.serie) subParts.push(eqp.serie);
      if(eqp.qr) subParts.push("QR: " + eqp.qr);

      left.innerHTML = `
        <div class="title">${escapeHtml(eqp.nome)}</div>
        <div class="sub">${escapeHtml(subParts.join(" • "))}</div>
      `;

      const btnDel = document.createElement('button');
      btnDel.className = 'err';
      btnDel.textContent = 'Excluir';
      btnDel.title = 'Excluir máquina';
      btnDel.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(confirm('Excluir máquina e todas as tarefas dela?')){
          store.equipamentos = store.equipamentos.filter(e=> e.id!==eqp.id);
          if(selectedEqpId===eqp.id) selectedEqpId=null;
          fullSave();
          renderEqpList();
          renderEqpSelect();
          renderTabela();
        }
      });

      div.appendChild(left);
      div.appendChild(btnDel);
      div.addEventListener('click', ()=> {
        setSelectedEqp(eqp);
        openTab('maquinas');
      });
      listaEqp.appendChild(div);
    });
  }

  // =========================
  // SELECT: MÁQUINAS (TAREFAS)
  // =========================
  function renderEqpSelect(){
    selEqpTarefa.innerHTML = '';

    if(!store.equipamentos.length){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Cadastre uma máquina primeiro';
      selEqpTarefa.appendChild(opt);
      selEqpTarefa.disabled = true;
      hintEqpTarefa.textContent = '';
      return;
    }

    selEqpTarefa.disabled = false;

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Selecione uma máquina…';
    selEqpTarefa.appendChild(placeholder);

    store.equipamentos.forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = e.qr ? `${e.nome} (QR: ${e.qr})` : e.nome;
      selEqpTarefa.appendChild(opt);
    });

    if(selectedEqpId && store.equipamentos.some(e=> e.id===selectedEqpId)){
      selEqpTarefa.value = selectedEqpId;
      const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
      hintEqpTarefa.textContent = buildEqpHint(eqp);
    }else{
      selEqpTarefa.value = '';
      hintEqpTarefa.textContent = '';
    }
  }

  // =========================
  // TAREFAS: MODO EDIÇÃO
  // =========================
  let editingTask = null; // { eqpId, tkId }
  let originalBtnAddText = null;

  function setTaskMode(isEdit){
    if(!originalBtnAddText) originalBtnAddText = btnAddTarefa.textContent || "Adicionar";
    if(isEdit){
      btnAddTarefa.textContent = "Salvar alterações";
      btnAddTarefa.classList.add("warn");
      btnAddTarefa.classList.remove("primary");
    }else{
      btnAddTarefa.textContent = originalBtnAddText || "Adicionar";
      btnAddTarefa.classList.add("primary");
      btnAddTarefa.classList.remove("warn");
      editingTask = null;
    }
  }

  function clearTaskForm(){
    tkTitulo.value  = '';
    tkPeriodo.value = '30';
    tkUltima.value  = '';
    tkObs.value     = '';
    setTaskMode(false);
  }

  function addTarefa(){
    const eqpIdSel = selEqpTarefa.value || '';
    if(!eqpIdSel){
      alert('Selecione a máquina para cadastrar a tarefa.');
      return;
    }

    const titulo = tkTitulo.value.trim();
    if(!titulo){
      alert('Informe o título da tarefa');
      return;
    }

    const periodo = parseInt(tkPeriodo.value,10) || 30;
    const ultimaISO = tkUltima.value || '';
    const obs = tkObs.value.trim();

    const eqp = store.equipamentos.find(e=> e.id===eqpIdSel);
    if(!eqp){
      alert('Erro: máquina não encontrada.');
      return;
    }

    // ✅ EDITAR
    if(editingTask && editingTask.eqpId === eqpIdSel){
      const tk = (eqp.tarefas||[]).find(t=> t.id === editingTask.tkId);
      if(!tk){
        alert('Erro: tarefa não encontrada.');
        setTaskMode(false);
        return;
      }
      tk.titulo = titulo;
      tk.periodo = periodo;
      tk.ultimaISO = ultimaISO;
      tk.obs = obs;

      fullSave();
      renderTabela();
      clearTaskForm();
      alert('Tarefa atualizada!');
      return;
    }

    // ✅ ADICIONAR
    eqp.tarefas.push({ id: uid(), titulo, periodo, ultimaISO, obs });

    fullSave();
    renderTabela();
    clearTaskForm();
  }

  // =========================
  // TABELA / KPI
  // =========================
  function computeNext(ultimaISO, periodo){
    const base = ultimaISO || todayISO();
    return addDays(base, periodo);
  }
  function statusFor(nextISO){
    const t = todayISO();
    if(nextISO < t) return {label:'ATRASADA', cls:'b-err'};
    const d = diffDays(nextISO, t);
    if(d <= 7) return {label:'EM BREVE', cls:'b-warn'};
    return {label:'OK', cls:'b-ok'};
  }

  function renderTabela(){
    const rows = [];
    store.equipamentos.forEach(eqp=>{
      (eqp.tarefas||[]).forEach(tk=>{
        const nextISO = computeNext(tk.ultimaISO, tk.periodo);
        rows.push({
          eqpId:eqp.id,
          tkId:tk.id,
          equipamento:eqp.nome,
          tarefa:tk.titulo,
          periodo:tk.periodo,
          ultima:tk.ultimaISO || '',
          proxima:nextISO,
          status:statusFor(nextISO),
          local:eqp.local||'',
          serie:eqp.serie||'',
          qr:eqp.qr||'',
          obs:tk.obs||''
        });
      });
    });

    const t = todayISO();
    const atr = rows.filter(r=> r.proxima < t).length;
    const ate7 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=7; }).length;
    const ate30 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=30; }).length;

    kpiAtr.textContent = atr;
    kpi7.textContent   = ate7;
    kpi30.textContent  = ate30;
    kpiTot.textContent = rows.length;

    const q = (busca.value || '').trim().toLowerCase();
    const fil = selFiltro.value;

    let lista = rows;
    lista = lista.filter(r=>{
      const passBusca = !q || `${r.equipamento} ${r.tarefa} ${r.local} ${r.serie} ${r.qr}`.toLowerCase().includes(q);
      let passFiltro = true;
      const d = diffDays(r.proxima, t);
      if(fil==='atrasadas') passFiltro = r.proxima < t;
      else if(fil==='sete') passFiltro = d>=0 && d<=7;
      else if(fil==='trinta') passFiltro = d>=0 && d<=30;
      return passBusca && passFiltro;
    });

    lista.sort((a,b)=> a.proxima.localeCompare(b.proxima));

    tbody.innerHTML = '';
    if(!lista.length){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="7" class="muted">Nenhuma tarefa cadastrada para o filtro atual.</td>';
      tbody.appendChild(tr);
      return;
    }

    lista.forEach(r=>{
      const metaParts = [];
      if(r.local) metaParts.push(r.local);
      if(r.serie) metaParts.push(r.serie);
      if(r.qr) metaParts.push("QR: " + r.qr);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${escapeHtml(r.equipamento)}</b><div class="muted">${escapeHtml(metaParts.join(" • "))}</div></td>
        <td>${escapeHtml(r.tarefa)}<div class="muted">${escapeHtml(r.obs||'')}</div></td>
        <td>${escapeHtml(String(r.periodo))}d</td>
        <td>${escapeHtml(fmtBR(r.ultima))}</td>
        <td>${escapeHtml(fmtBR(r.proxima))}</td>
        <td><span class="badge ${r.status.cls}">${escapeHtml(r.status.label)}</span></td>
        <td>
          <div class="row">
            <button class="ok" data-done="${r.eqpId}|${r.tkId}" type="button">Feita hoje</button>
            <button class="ghost" data-edit="${r.eqpId}|${r.tkId}" type="button">Editar</button>
            <button class="err" data-del="${r.eqpId}|${r.tkId}" type="button">Excluir</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Delegação de ações na tabela
  tbody.addEventListener('click', (ev)=>{
    const el = ev.target;
    if(!(el instanceof HTMLElement)) return;

    if(el.hasAttribute('data-done')){
      const [eqpId, tkId] = el.getAttribute('data-done').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      const tk = eqp?.tarefas?.find(x=> x.id===tkId);
      if(tk){
        tk.ultimaISO = todayISO();
        fullSave();
        renderTabela();
      }
    }else if(el.hasAttribute('data-edit')){
      const [eqpId, tkId] = el.getAttribute('data-edit').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      const tk = eqp?.tarefas?.find(x=> x.id===tkId);
      if(eqp && tk){
        openTab('tarefas');

        selectedEqpId = eqp.id;
        renderEqpSelect();
        selEqpTarefa.value = eqp.id;
        hintEqpTarefa.textContent = buildEqpHint(eqp);

        tkTitulo.value  = tk.titulo;
        tkPeriodo.value = String(tk.periodo);
        tkUltima.value  = tk.ultimaISO || '';
        tkObs.value     = tk.obs || '';

        editingTask = { eqpId, tkId };
        setTaskMode(true);

        window.scrollTo({top:0,behavior:'smooth'});
      }
    }else if(el.hasAttribute('data-del')){
      const [eqpId, tkId] = el.getAttribute('data-del').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      if(!eqp) return;
      if(confirm('Excluir esta tarefa?')){
        eqp.tarefas = (eqp.tarefas||[]).filter(x=> x.id!==tkId);
        fullSave();
        renderTabela();
        if(editingTask && editingTask.eqpId===eqpId && editingTask.tkId===tkId){
          clearTaskForm();
        }
      }
    }
  });

  // =========================
  // QR: LOADER + MODAL + SCAN
  // =========================
  const qrModal = document.getElementById('qrModal');
  const btnCloseQr = document.getElementById('btnCloseQr');
  const btnStopQr = document.getElementById('btnStopQr');
  const btnSwitchCamera = document.getElementById('btnSwitchCamera');
  const qrModalTitle = document.getElementById('qrModalTitle');
  const qrHint = document.getElementById('qrHint');
  const qrHelp = document.getElementById('qrHelp');

  let __qrLibLoading = null;

  function loadScriptOnce(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = ()=> resolve(true);
      s.onerror = ()=> reject(new Error("Falhou: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureQrLibLoaded(){
    if(typeof Html5Qrcode !== "undefined") return true;
    if(__qrLibLoading) return __qrLibLoading;

    __qrLibLoading = (async ()=>{
      const sources = [
        "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
        "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
        "./html5-qrcode.min.js" // opcional: se você colocar no repo
      ];

      let lastErr = null;
      for(const src of sources){
        try{
          await loadScriptOnce(src);
          if(typeof Html5Qrcode !== "undefined") return true;
        }catch(e){
          lastErr = e;
        }
      }
      console.error(lastErr);
      return false;
    })();

    return __qrLibLoading;
  }

  function showQrModal(title, hint){
    qrModalTitle.textContent = title || "Ler QR Code";
    qrHint.textContent = hint || "Aponte a câmera para o QR da máquina.";
    qrHelp.textContent =
      "Dicas: a câmera só funciona em HTTPS (GitHub Pages ok). " +
      "Se a rede bloquear CDNs, coloque o arquivo 'html5-qrcode.min.js' no repositório.";
    qrModal.classList.add('show');
    qrModal.setAttribute('aria-hidden','false');
  }
  function hideQrModal(){
    qrModal.classList.remove('show');
    qrModal.setAttribute('aria-hidden','true');
  }

  let qrScanner = null;
  let qrContext = "machine"; // "machine" | "task"
  let cameraList = [];
  let cameraIndex = 0;
  let currentCameraId = null;

  async function stopQr(){
    try{
      if(qrScanner){
        await qrScanner.stop();
        await qrScanner.clear();
      }
    }catch(e){
      // ignore
    }finally{
      qrScanner = null;
      hideQrModal();
    }
  }

  function findEqpByQr(code){
    const c = String(code||"").trim();
    if(!c) return null;
    return store.equipamentos.find(e => (e.qr||"").trim() === c) || null;
  }

  function handleQrResult(code){
    const eqp = findEqpByQr(code);

    if(eqp){
      selectedEqpId = eqp.id;

      if(qrContext === "task"){
        openTab('tarefas');
        renderEqpSelect();
        selEqpTarefa.value = eqp.id;
        hintEqpTarefa.textContent = buildEqpHint(eqp);
        setTaskMode(false);
      }else{
        openTab('maquinas');
        setSelectedEqp(eqp);
      }
      return;
    }

    // QR não cadastrado
    if(qrContext === "machine"){
      openTab('maquinas');
      clearEqpForm();
      eqQr.value = code;
      infoEqpSel.textContent = "QR lido: " + code + " (não cadastrado). Preencha nome e salve.";
      eqNome.focus();
    }else{
      alert("QR não cadastrado: " + code + "\nCadastre a máquina primeiro na aba Máquinas.");
      openTab('maquinas');
    }
  }

  async function startQrScan(context){
    const ok = await ensureQrLibLoaded();
    if(!ok){
      alert(
        "Não consegui carregar o leitor de QR.\n" +
        "Possíveis causas:\n" +
        "• Rede bloqueou CDN (empresa)\n" +
        "• Sem internet\n\n" +
        "Solução definitiva: coloque 'html5-qrcode.min.js' no repositório (mesma pasta do index.html)."
      );
      return;
    }

    qrContext = context || "machine";

    showQrModal(
      qrContext === "task" ? "Ler QR — Selecionar Máquina" : "Ler QR — Buscar Máquina",
      "Aponte a câmera para o QR grudado na máquina."
    );

    // garantir instância limpa
    try{
      if(qrScanner){
        await qrScanner.stop();
        await qrScanner.clear();
      }
    }catch{}
    qrScanner = new Html5Qrcode("qr-reader");

    // checar HTTPS (camera)
    if(!(location.protocol === "https:" || location.hostname === "localhost")){
      qrHelp.textContent =
        "⚠️ A câmera só funciona em HTTPS ou localhost. Publique no GitHub Pages (https) para usar.";
    }

    // listar câmeras
    try{
      cameraList = await Html5Qrcode.getCameras();
      if(!cameraList || !cameraList.length){
        alert("Nenhuma câmera encontrada.");
        await stopQr();
        return;
      }

      // tenta priorizar traseira
      const backIndex = cameraList.findIndex(c => /back|traseira|rear/i.test(c.label||""));
      cameraIndex = backIndex >= 0 ? backIndex : 0;
      currentCameraId = cameraList[cameraIndex].id;

    }catch(err){
      console.error(err);
      alert("Não foi possível acessar a câmera. Dê permissão e tente novamente.");
      await stopQr();
      return;
    }

    // iniciar scan
    try{
      await qrScanner.start(
        { deviceId: { exact: currentCameraId } },
        { fps: 10, qrbox: { width: 260, height: 260 } },
        async (decodedText)=>{
          const code = String(decodedText||"").trim();
          if(!code) return;

          // parar rápido (evitar repetir)
          await stopQr();
          handleQrResult(code);
        },
        ()=>{}
      );
    }catch(err){
      console.error(err);
      alert("Erro ao iniciar o leitor. Se estiver no PC, verifique permissões/bloqueios do navegador.");
      await stopQr();
    }
  }

  btnCloseQr.addEventListener('click', stopQr);
  btnStopQr.addEventListener('click', stopQr);

  btnSwitchCamera.addEventListener('click', async ()=>{
    if(!cameraList.length){
      alert("Câmeras não carregadas.");
      return;
    }
    cameraIndex = (cameraIndex + 1) % cameraList.length;
    currentCameraId = cameraList[cameraIndex].id;

    // reiniciar
    try{
      if(qrScanner){
        await qrScanner.stop();
        await qrScanner.clear();
      }
      qrScanner = new Html5Qrcode("qr-reader");
      await qrScanner.start(
        { deviceId: { exact: currentCameraId } },
        { fps: 10, qrbox: { width: 260, height: 260 } },
        async (decodedText)=>{
          const code = String(decodedText||"").trim();
          if(!code) return;
          await stopQr();
          handleQrResult(code);
        },
        ()=>{}
      );
    }catch(err){
      console.error(err);
      alert("Não foi possível trocar a câmera.");
      await stopQr();
    }
  });

  // =========================
  // INIT APP
  // =========================
  function initAppOnce(){
    if(appInitialized) return;
    appInitialized = true;

    todaySpan.textContent = new Date().toLocaleDateString('pt-BR');

    loadLocal();
    renderEqpList();
    renderEqpSelect();
    renderTabela();
    syncFromFirebaseOnce();

    // tabs
    tabMaquinas.addEventListener('click', ()=> openTab('maquinas'));
    tabTarefas.addEventListener('click', ()=> openTab('tarefas'));

    // select tarefa: trocar máquina cancela edição
    selEqpTarefa.addEventListener('change', ()=>{
      const id = selEqpTarefa.value;
      selectedEqpId = id || null;
      const eqp = store.equipamentos.find(e=> e.id===id);
      hintEqpTarefa.textContent = eqp ? buildEqpHint(eqp) : '';
      setTaskMode(false);
    });

    // botões
    btnSalvarEqp.addEventListener('click', addOrUpdateEquipamento);
    btnLimparEqp.addEventListener('click', clearEqpForm);
    btnAddTarefa.addEventListener('click', addTarefa);
    btnLimparTarefa.addEventListener('click', clearTaskForm);

    btnNovoEqp.addEventListener('click', ()=>{
      clearEqpForm();
      clearTaskForm();
      openTab('maquinas');
    });

    // filtros
    busca.addEventListener('input', renderTabela);
    selFiltro.addEventListener('change', renderTabela);

    // QR
    btnScanQrMachine.addEventListener('click', ()=> startQrScan("machine"));
    btnScanQrTask.addEventListener('click', ()=> startQrScan("task"));
    btnOpenQrTop.addEventListener('click', ()=> startQrScan("task"));

    // estado inicial
    setTaskMode(false);
  }

  // =========================
  // AUTH
  // =========================
  auth.onAuthStateChanged(user=>{
    if(user && allowedEmails.includes(user.email)){
      showApp(user);
      initAppOnce();
    }else{
      if(user && !allowedEmails.includes(user.email)){
        auth.signOut();
      }
      showLogin();
    }
  });

  btnLogin.addEventListener('click', ()=>{
    const email = loginEmail.value.trim();
    const senha = loginSenha.value;
    if(!email || !senha){
      loginError.textContent = "Preencha e-mail e senha.";
      return;
    }
    setLoginLoading(true);
    loginError.textContent = "";
    auth.signInWithEmailAndPassword(email, senha)
      .then(cred=>{
        const user = cred.user;
        if(!allowedEmails.includes(user.email)){
          auth.signOut();
          loginError.textContent = "Seu usuário não tem permissão para acessar este painel.";
        }
      })
      .catch(err=>{
        console.error(err);
        loginError.textContent = "Login inválido. Verifique e-mail e senha.";
      })
      .finally(()=> setLoginLoading(false));
  });

  btnLogout.addEventListener('click', ()=> auth.signOut());

  // =========================
  // UTIL: escape (segurança)
  // =========================
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // start
  showLogin();
</script>

</body>
</html>
