<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preventivas ‚Äî Grilazer (ERP)</title>

  <!-- Firebase compat (app + db + auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#fbfcff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --border2:#eef2f7;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;

      --shadow: 0 14px 35px rgba(15,23,42,.08);
      --shadow2: 0 10px 25px rgba(15,23,42,.06);
      --radius: 16px;
      --radius2: 12px;

      --sidebarW: 260px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, #fafbff, var(--bg));
    }

    /* ========== LOGIN ========== */
    #login-screen{
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(1100px 600px at 15% -10%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.07), transparent 55%),
        linear-gradient(180deg, #fafbff, var(--bg));
    }
    .login-card{
      width:100%;
      max-width:420px;
      padding:18px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .login-card h1{margin:0;font-size:18px;font-weight:950}
    .login-card p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:800}
    .field input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    .field input:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .btn{
      margin-top:8px;
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(37,99,235,.16);
    }
    .btn:disabled{opacity:.65;cursor:wait}
    .login-error{margin-top:4px;font-size:12px;color:var(--err);min-height:14px}
    .login-foot{font-size:11px;color:var(--muted);margin-top:2px}

    /* ========== APP SHELL (ERP) ========== */
    #app-shell{display:none; min-height:100dvh;}
    .shell{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      min-height:100dvh;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, #fff, #fbfcff);
      border-right:1px solid var(--border);
      padding:14px;
      position:sticky;
      top:0;
      height:100dvh;
      overflow:auto;
    }
    .sb-brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .sb-logo{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.20);
      color:#0b2a7a;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .sb-title{line-height:1.1}
    .sb-title b{display:block;font-size:13px;font-weight:1000}
    .sb-title small{display:block;font-size:11px;color:var(--muted);margin-top:2px}

    .sb-nav{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .nav-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight:950;
      color: rgba(15,23,42,.86);
      user-select:none;
    }
    .nav-item:hover{background:#f8fafc; border-color: var(--border)}
    .nav-item.active{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.25);
      color:#0b2a7a;
    }
    .nav-ico{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }
    .sb-foot{
      margin-top:14px;
      border-top:1px solid var(--border2);
      padding-top:12px;
    }
    .sb-foot .muted{font-size:11px;color:var(--muted);line-height:1.35}
    .sb-foot .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

    /* Topbar */
    .main{
      padding:16px;
      background: transparent;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow2);
      position:sticky;
      top:0;
      z-index:5;
    }
    .topbar-left{display:flex;flex-direction:column}
    .topbar-left b{font-size:14px;font-weight:1000}
    .topbar-left small{font-size:11px;color:var(--muted);margin-top:2px}
    .topbar-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color: var(--muted);
      font-weight:900;
      font-size:11px;
    }

    /* Controls */
    button{
      appearance:none;
      border:1px solid var(--border);
      border-radius: 12px;
      padding:9px 11px;
      font-weight:950;
      cursor:pointer;
      background:#fff;
      color: var(--text);
      transition: transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    }
    button:hover{border-color:#cbd5e1;box-shadow: 0 10px 18px rgba(15,23,42,.08)}
    button:active{transform: translateY(1px)}
    .primary{
      color:#fff;
      border-color: rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 18px rgba(37,99,235,.16);
    }
    .ghost{background:#fff}
    .danger{
      color:#fff;
      border-color: rgba(239,68,68,.25);
      background: linear-gradient(135deg, #f87171, #ef4444);
    }
    .ok{
      color:#fff;
      border-color: rgba(22,163,74,.25);
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    .warn{
      color:#fff;
      border-color: rgba(245,158,11,.25);
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }

    /* Content */
    .content{
      margin-top:14px;
      display:grid;
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .card h2{margin:0;font-size:14px;font-weight:1000}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .sep{height:1px;background: var(--border2);margin:12px 0}

    /* Grid inside pages */
    .grid-2{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }

    label{
      display:block;
      font-weight:900;
      margin:10px 0 6px;
      font-size:12px;
      color: rgba(15,23,42,.85);
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:76px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    /* Lists */
    .list{
      margin-top:10px;
      max-height:320px;
      overflow:auto;
      padding-right:2px;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      margin-top:8px;
    }
    .item:hover{background:#f8fafc;border-color:#cbd5e1}
    .item.active{background: rgba(37,99,235,.08); border-color: rgba(37,99,235,.25)}
    .item b{display:block;font-weight:1000}
    .item small{display:block;margin-top:2px;color:var(--muted);font-size:11px;line-height:1.3}
    .item .actions{display:flex;gap:8px;align-items:flex-start}
    .icon-btn{
      width:36px;height:36px;
      border-radius: 12px;
      display:grid;place-items:center;
      padding:0;
      font-size:14px;
    }

    /* KPIs */
    .kpis{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      padding:12px;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
    }
    .kpi .label{color:var(--muted);font-size:12px;font-weight:900}
    .kpi .value{font-size:22px;font-weight:1100;margin-top:6px}
    .kpi .hint{color:var(--muted);font-size:11px;margin-top:4px}

    /* Table */
    .table-wrap{
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background:#f8fafc;
      color: rgba(15,23,42,.75);
      font-size:12px;
      letter-spacing:.2px;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--border2);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--border2);
      vertical-align:top;
    }
    tbody tr:nth-child(even){background:#fcfdff}
    tbody tr:hover{background:#f8fafc}
    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:11px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .b-ok{background:#ecfdf5;color:#166534;border-color:#86efac}
    .b-warn{background:#fffbeb;color:#92400e;border-color:#fde68a}
    .b-err{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}

    /* Filters bar */
    .filters{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* Toast */
    .toast-wrap{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
    }
    .toast{
      min-width: 260px;
      max-width: 360px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .toast .dot{
      width:10px;height:10px;border-radius:999px;margin-top:4px;
      background: var(--primary);
      flex:0 0 auto;
    }
    .toast.ok .dot{background: var(--ok)}
    .toast.warn .dot{background: var(--warn)}
    .toast.err .dot{background: var(--err)}
    .toast b{display:block;font-size:12px;font-weight:1000}
    .toast p{margin:2px 0 0 0;font-size:12px;color:var(--muted);line-height:1.3}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9998;
    }
    .modal.show{display:flex}
    .modal-card{
      width:min(560px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--border2);
      background: linear-gradient(180deg, #fff, #fbfcff);
    }
    .modal-title{font-weight:1000;font-size:13px}
    .modal-body{padding:12px}
    .modal-foot{
      display:flex;
      gap:8px;
      padding:12px;
      border-top:1px solid var(--border2);
      justify-content:flex-end;
      background:#fff;
    }

    /* Responsive */
    @media (max-width: 1020px){
      .shell{grid-template-columns: 1fr}
      .sidebar{
        position:relative;
        height:auto;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      .grid-2{grid-template-columns: 1fr}
      .topbar{position:relative}
    }
    @media print{
      body{background:#fff}
      .sidebar, .topbar, .toast-wrap, .modal{display:none !important}
      .main{padding:0}
      .card{box-shadow:none}
      .table-wrap{border:1px solid #ddd}
      thead th{position:static}
    }
  </style>
</head>

<body>

  <!-- ========== LOGIN ========== -->
  <section id="login-screen">
    <div class="login-card">
      <h1>Preventivas ‚Äî Grilazer</h1>
      <p>Fa√ßa login com seu e-mail autorizado para acessar o painel.</p>

      <div class="field">
        <label for="loginEmail">E-mail</label>
        <input type="email" id="loginEmail" autocomplete="email" placeholder="engenhariagrilazer@gmail.com">
      </div>

      <div class="field">
        <label for="loginSenha">Senha</label>
        <input type="password" id="loginSenha" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <button class="btn" id="btnLogin">Entrar</button>
      <div class="login-error" id="loginError"></div>

      <div class="login-foot">
        Usu√°rios s√£o gerenciados no Firebase Authentication (E-mail/Senha).
      </div>
    </div>
  </section>

  <!-- ========== APP ========== -->
  <div id="app-shell">
    <div class="shell">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sb-brand">
          <div class="sb-logo">GR</div>
          <div class="sb-title">
            <b>Preventivas</b>
            <small>Grilazer ‚Äî ERP</small>
          </div>
        </div>

        <nav class="sb-nav" style="margin-top:12px">
          <div class="nav-item active" data-nav="dashboard">
            <div class="nav-ico">üìä</div> Dashboard
          </div>
          <div class="nav-item" data-nav="maquinas">
            <div class="nav-ico">üè≠</div> M√°quinas
          </div>
          <div class="nav-item" data-nav="tarefas">
            <div class="nav-ico">üß∞</div> Tarefas
          </div>
          <div class="nav-item" data-nav="relatorios">
            <div class="nav-ico">üßæ</div> Relat√≥rios
          </div>
        </nav>

        <div class="sb-foot">
          <div class="muted" id="userInfoSide">‚Äî</div>
          <div class="muted" id="syncStatus">Sincroniza√ß√£o: carregando‚Ä¶</div>

          <div class="row">
            <button class="ghost" id="btnPrintGlobal" type="button">Imprimir</button>
            <button class="ghost" id="btnLogout" type="button">Sair</button>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="topbar">
          <div class="topbar-left">
            <b id="pageTitle">Dashboard</b>
            <small id="pageSubtitle">Vis√£o geral das preventivas</small>
          </div>

          <div class="topbar-right">
            <span class="pill">Hoje: <span id="today"></span></span>
            <span class="pill" id="netPill">Status: ‚Äî</span>
          </div>
        </div>

        <div class="content">
          <!-- ========== PAGE: DASHBOARD ========== -->
          <section class="page active" id="page-dashboard">
            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:baseline">
                <h2>Indicadores</h2>
                <div class="muted">Acompanhe atrasos e pr√≥ximos vencimentos</div>
              </div>

              <div class="kpis">
                <div class="kpi">
                  <div class="label">Atrasadas</div>
                  <div class="value" id="kpiAtr">0</div>
                  <div class="hint">Pr√≥xima a√ß√£o: priorizar as vencidas</div>
                </div>
                <div class="kpi">
                  <div class="label">At√© 7 dias</div>
                  <div class="value" id="kpi7">0</div>
                  <div class="hint">Planejamento da semana</div>
                </div>
                <div class="kpi">
                  <div class="label">At√© 30 dias</div>
                  <div class="value" id="kpi30">0</div>
                  <div class="hint">Planejamento do m√™s</div>
                </div>
                <div class="kpi">
                  <div class="label">Total de tarefas</div>
                  <div class="value" id="kpiTot">0</div>
                  <div class="hint" id="kpiMeta">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:center">
                <div>
                  <h2>Tarefas mais urgentes</h2>
                  <div class="muted">Top 20 por data de vencimento</div>
                </div>
                <div class="right-actions">
                  <select id="dashFiltro">
                    <option value="todas">Todas</option>
                    <option value="atrasadas">Atrasadas</option>
                    <option value="sete">Pr√≥x. 7 dias</option>
                    <option value="trinta">Pr√≥x. 30 dias</option>
                  </select>
                  <button class="primary" id="btnGoRelatorio" type="button">Gerar relat√≥rio</button>
                </div>
              </div>

              <div class="sep"></div>

              <div class="table-wrap" style="max-height:420px; overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>M√°quina</th>
                      <th>Tarefa</th>
                      <th>Pr√≥xima</th>
                      <th>Status</th>
                      <th style="width:220px">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyDash"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ========== PAGE: M√ÅQUINAS ========== -->
          <section class="page" id="page-maquinas">
            <div class="grid-2">
              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:baseline">
                  <h2>Cadastro de M√°quina</h2>
                  <button class="ghost" id="btnNovoEqp" type="button">Novo</button>
                </div>
                <div class="muted" id="infoEqpSel">Nenhuma m√°quina selecionada.</div>

                <label for="eqNome">Nome da m√°quina</label>
                <input id="eqNome" placeholder="Ex.: Prensa Hidr√°ulica 30T">

                <label for="eqLocal">Local / Setor</label>
                <input id="eqLocal" placeholder="Ex.: Metal√∫rgica, Setor A">

                <label for="eqSerie">N¬∫ de S√©rie / Patrim√¥nio</label>
                <input id="eqSerie" placeholder="Ex.: SER-000123 / PAT-045">

                <div class="row" style="margin-top:10px">
                  <button class="primary" id="btnSalvarEqp" type="button">Salvar</button>
                  <button class="ghost" id="btnLimparEqp" type="button">Limpar</button>
                </div>

                <div class="sep"></div>
                <div class="muted">
                  Dica: mantenha ‚ÄúLocal/Setor‚Äù padronizado (ex.: Pintura, Montagem, Metal√∫rgica) para facilitar relat√≥rios.
                </div>
              </div>

              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:baseline">
                  <h2>M√°quinas cadastradas</h2>
                  <div class="muted" id="countEqp">0</div>
                </div>
                <div class="filters" style="margin-top:10px">
                  <input id="buscaEqp" placeholder="Buscar m√°quina‚Ä¶" style="flex:1; min-width:220px">
                </div>

                <div class="list" id="listaEqp"></div>
                <div class="muted" id="emptyEqp" style="display:none; margin-top:10px">
                  Nenhuma m√°quina cadastrada. Cadastre a primeira √† esquerda.
                </div>
              </div>
            </div>
          </section>

          <!-- ========== PAGE: TAREFAS ========== -->
          <section class="page" id="page-tarefas">
            <div class="grid-2">
              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:baseline">
                  <h2>Cadastro de Tarefa</h2>
                  <button class="ghost" id="btnLimparTarefa" type="button">Limpar</button>
                </div>
                <div class="muted">Selecione a m√°quina e cadastre a tarefa. Para editar, use o bot√£o ‚ÄúEditar‚Äù na tabela.</div>

                <label for="selEqpTarefa">M√°quina</label>
                <select id="selEqpTarefa"></select>
                <div class="muted" id="hintEqpTarefa" style="margin-top:6px"></div>

                <label for="tkTitulo">T√≠tulo</label>
                <input id="tkTitulo" placeholder="Ex.: Lubrificar guias e mancais">

                <div class="row">
                  <div style="flex:1; min-width:160px">
                    <label for="tkPeriodo">Periodicidade</label>
                    <select id="tkPeriodo">
                      <option value="30">30 dias</option>
                      <option value="90">90 dias</option>
                      <option value="180">180 dias</option>
                      <option value="360">360 dias</option>
                    </select>
                  </div>
                  <div style="flex:1; min-width:160px">
                    <label for="tkUltima">√öltima execu√ß√£o</label>
                    <input id="tkUltima" type="date">
                  </div>
                </div>

                <label for="tkObs">Observa√ß√µes</label>
                <textarea id="tkObs" placeholder="Materiais, check-list, seguran√ßa, etc."></textarea>

                <div class="row" style="margin-top:10px">
                  <button class="primary" id="btnSalvarTarefa" type="button">Adicionar</button>
                </div>

                <div class="sep"></div>
                <div class="muted">
                  Dica: ‚ÄúFeita hoje‚Äù atualiza automaticamente a data da √∫ltima execu√ß√£o.
                </div>
              </div>

              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:baseline">
                  <h2>Lista de tarefas</h2>
                  <div class="muted">Filtre e mantenha a rotina</div>
                </div>

                <div class="filters" style="margin-top:10px">
                  <input id="busca" placeholder="Buscar por m√°quina/tarefa‚Ä¶" style="flex:1; min-width:240px">
                  <select id="selFiltro">
                    <option value="todos">Todos</option>
                    <option value="atrasadas">Atrasadas</option>
                    <option value="sete">Pr√≥x. 7 dias</option>
                    <option value="trinta">Pr√≥x. 30 dias</option>
                  </select>
                </div>

                <div class="sep"></div>

                <div class="table-wrap" style="max-height:520px; overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>M√°quina</th>
                        <th>Tarefa</th>
                        <th>Per√≠odo</th>
                        <th>√öltima</th>
                        <th>Pr√≥xima</th>
                        <th>Status</th>
                        <th style="width:260px">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- ========== PAGE: RELAT√ìRIOS ========== -->
          <section class="page" id="page-relatorios">
            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:baseline">
                <h2>Relat√≥rios</h2>
                <div class="muted">Gere um relat√≥rio para imprimir ou exportar CSV</div>
              </div>

              <div class="sep"></div>

              <div class="grid-2" style="grid-template-columns: 420px 1fr">
                <div>
                  <label for="repFiltro">Tipo</label>
                  <select id="repFiltro">
                    <option value="atrasadas">Somente atrasadas</option>
                    <option value="sete">Pr√≥ximas 7 dias</option>
                    <option value="trinta">Pr√≥ximas 30 dias</option>
                    <option value="todos">Todas</option>
                  </select>

                  <label for="repLocal">Filtrar por Local/Setor (opcional)</label>
                  <input id="repLocal" placeholder="Ex.: Pintura">

                  <label for="repMaquina">Filtrar por M√°quina (opcional)</label>
                  <select id="repMaquina"></select>

                  <div class="row" style="margin-top:12px">
                    <button class="primary" id="btnGerarRelatorio" type="button">Gerar (Imprimir)</button>
                    <button class="ghost" id="btnBaixarCSV" type="button">Baixar CSV</button>
                  </div>

                  <div class="sep"></div>
                  <div class="muted">
                    Observa√ß√£o: o relat√≥rio considera a ‚ÄúPr√≥xima execu√ß√£o‚Äù calculada pela periodicidade.
                  </div>
                </div>

                <div>
                  <div class="row" style="justify-content:space-between; align-items:baseline">
                    <h2>Pr√©via</h2>
                    <div class="muted" id="repCount">0 itens</div>
                  </div>

                  <div class="sep"></div>

                  <div class="table-wrap" style="max-height:520px; overflow:auto">
                    <table>
                      <thead>
                        <tr>
                          <th>M√°quina</th>
                          <th>Local</th>
                          <th>Tarefa</th>
                          <th>Pr√≥xima</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyRep"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Confirm Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="confirmTitle">Confirmar</div>
        <button class="ghost" id="confirmClose" type="button">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="muted" id="confirmText">‚Äî</div>
      </div>
      <div class="modal-foot">
        <button class="ghost" id="confirmCancel" type="button">Cancelar</button>
        <button class="danger" id="confirmOk" type="button">Confirmar</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG FIREBASE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDNrOyDmI5NOkVuG3yh8HkDrn4dqYXOrW0",
  authDomain: "preventivas-27185.firebaseapp.com",
  databaseURL: "https://preventivas-27185-default-rtdb.firebaseio.com",
  projectId: "preventivas-27185",
  storageBucket: "preventivas-27185.firebasestorage.app",
  messagingSenderId: "862235462324",
  appId: "1:862235462324:web:bcf4948b6b5bb96cbee5e1",
  measurementId: "G-8D16CFDLZV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const DB_PATH = "preventivas_grilazer";

// e-mails autorizados
const allowedEmails = ["engenhariagrilazer@gmail.com"];

/* =========================
   ELEMENTOS
========================= */
const loginScreen = document.getElementById("login-screen");
const appShell = document.getElementById("app-shell");
const loginEmail = document.getElementById("loginEmail");
const loginSenha = document.getElementById("loginSenha");
const btnLogin = document.getElementById("btnLogin");
const loginError = document.getElementById("loginError");
const btnLogout = document.getElementById("btnLogout");
const btnPrintGlobal = document.getElementById("btnPrintGlobal");

const userInfoSide = document.getElementById("userInfoSide");
const syncStatus = document.getElementById("syncStatus");
const todaySpan = document.getElementById("today");
const netPill = document.getElementById("netPill");

// nav
const navItems = Array.from(document.querySelectorAll(".nav-item"));
const pages = {
  dashboard: document.getElementById("page-dashboard"),
  maquinas: document.getElementById("page-maquinas"),
  tarefas: document.getElementById("page-tarefas"),
  relatorios: document.getElementById("page-relatorios")
};
const pageTitle = document.getElementById("pageTitle");
const pageSubtitle = document.getElementById("pageSubtitle");

// dashboard
const kpiAtr = document.getElementById("kpiAtr");
const kpi7 = document.getElementById("kpi7");
const kpi30 = document.getElementById("kpi30");
const kpiTot = document.getElementById("kpiTot");
const kpiMeta = document.getElementById("kpiMeta");
const dashFiltro = document.getElementById("dashFiltro");
const tbodyDash = document.getElementById("tbodyDash");
const btnGoRelatorio = document.getElementById("btnGoRelatorio");

// maquinas
const eqNome = document.getElementById("eqNome");
const eqLocal = document.getElementById("eqLocal");
const eqSerie = document.getElementById("eqSerie");
const infoEqpSel = document.getElementById("infoEqpSel");
const listaEqp = document.getElementById("listaEqp");
const emptyEqp = document.getElementById("emptyEqp");
const countEqp = document.getElementById("countEqp");
const buscaEqp = document.getElementById("buscaEqp");
const btnNovoEqp = document.getElementById("btnNovoEqp");
const btnSalvarEqp = document.getElementById("btnSalvarEqp");
const btnLimparEqp = document.getElementById("btnLimparEqp");

// tarefas
const selEqpTarefa = document.getElementById("selEqpTarefa");
const hintEqpTarefa = document.getElementById("hintEqpTarefa");
const tkTitulo = document.getElementById("tkTitulo");
const tkPeriodo = document.getElementById("tkPeriodo");
const tkUltima = document.getElementById("tkUltima");
const tkObs = document.getElementById("tkObs");
const btnSalvarTarefa = document.getElementById("btnSalvarTarefa");
const btnLimparTarefa = document.getElementById("btnLimparTarefa");
const busca = document.getElementById("busca");
const selFiltro = document.getElementById("selFiltro");
const tbody = document.getElementById("tbody");

// relatorios
const repFiltro = document.getElementById("repFiltro");
const repLocal = document.getElementById("repLocal");
const repMaquina = document.getElementById("repMaquina");
const btnGerarRelatorio = document.getElementById("btnGerarRelatorio");
const btnBaixarCSV = document.getElementById("btnBaixarCSV");
const repCount = document.getElementById("repCount");
const tbodyRep = document.getElementById("tbodyRep");

// toast
const toastWrap = document.getElementById("toastWrap");

// confirm modal
const confirmModal = document.getElementById("confirmModal");
const confirmTitle = document.getElementById("confirmTitle");
const confirmText = document.getElementById("confirmText");
const confirmClose = document.getElementById("confirmClose");
const confirmCancel = document.getElementById("confirmCancel");
const confirmOk = document.getElementById("confirmOk");
let __confirmResolve = null;

/* =========================
   ESTADO / STORE
========================= */
let store = { equipamentos: [] };
let selectedEqpId = null;
let appInitialized = false;

// modo edi√ß√£o de tarefa
let editingTask = null; // {eqpId, tkId}

/* =========================
   HELPERS
========================= */
const todayISO = ()=> new Date().toISOString().slice(0,10);
const addDays = (iso, n)=>{
  const d = iso ? new Date(iso) : new Date();
  d.setHours(12,0,0,0);
  d.setDate(d.getDate() + n);
  return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
};
const diffDays = (a,b)=> Math.floor((new Date(a) - new Date(b)) / (1000*60*60*24));
const fmtBR = (iso)=> iso ? new Date(iso+'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî';
const uid = ()=> 'id-'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(4);

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function toast(type, title, msg, ms=2600){
  const el = document.createElement("div");
  el.className = "toast " + (type || "");
  el.innerHTML = `
    <div class="dot"></div>
    <div>
      <b>${escapeHtml(title || "Aviso")}</b>
      <p>${escapeHtml(msg || "")}</p>
    </div>
  `;
  toastWrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(4px)"; }, ms-350);
  setTimeout(()=>{ el.remove(); }, ms);
}

function setSyncStatus(text){
  syncStatus.textContent = "Sincroniza√ß√£o: " + text;
}

function computeNext(ultimaISO, periodo){
  const base = ultimaISO || todayISO();
  return addDays(base, periodo);
}
function statusFor(nextISO){
  const t = todayISO();
  if(nextISO < t) return {label:'ATRASADA', cls:'b-err'};
  const d = diffDays(nextISO, t);
  if(d === 0) return {label:'VENCE HOJE', cls:'b-warn'};
  if(d <= 7) return {label:'EM BREVE', cls:'b-warn'};
  return {label:'OK', cls:'b-ok'};
}

/* =========================
   CONFIRM MODAL
========================= */
function confirmBox(title, text){
  confirmTitle.textContent = title || "Confirmar";
  confirmText.textContent = text || "Tem certeza?";
  confirmModal.classList.add("show");
  return new Promise(resolve=>{
    __confirmResolve = resolve;
  });
}
function closeConfirm(result){
  confirmModal.classList.remove("show");
  if(__confirmResolve){
    __confirmResolve(!!result);
    __confirmResolve = null;
  }
}
confirmClose.addEventListener("click", ()=> closeConfirm(false));
confirmCancel.addEventListener("click", ()=> closeConfirm(false));
confirmOk.addEventListener("click", ()=> closeConfirm(true));
confirmModal.addEventListener("click", (e)=>{
  if(e.target === confirmModal) closeConfirm(false);
});

/* =========================
   LOCAL STORAGE (backup)
========================= */
function loadLocal(){
  try{
    const raw = localStorage.getItem("preventivas");
    if(raw) store = JSON.parse(raw);
  }catch{}
}
function saveLocal(){
  try{ localStorage.setItem("preventivas", JSON.stringify(store)); }catch{}
}

/* =========================
   FIREBASE SYNC
========================= */
function saveRemote(){
  setSyncStatus("enviando ao servidor‚Ä¶");
  db.ref(DB_PATH).set(store)
    .then(()=> setSyncStatus("ok (sincronizado)"))
    .catch(err=>{
      console.error(err);
      setSyncStatus("erro ao sincronizar (ver console)");
      toast("warn","Sem sincronizar","Falha ao enviar. Dados est√£o no navegador (local).");
    });
}

function fullSave(){
  saveLocal();
  saveRemote();
}

function syncFromFirebaseOnce(){
  setSyncStatus("carregando do servidor‚Ä¶");
  db.ref(DB_PATH).once("value")
    .then(snapshot=>{
      const val = snapshot.val();
      if(val && Array.isArray(val.equipamentos)){
        store = val;
        saveLocal();
      }
    })
    .catch(err=>{
      console.error(err);
      setSyncStatus("erro ao carregar (usando dados locais)");
      toast("warn","Modo local","N√£o consegui carregar do servidor. Vou usar os dados do navegador.");
    })
    .finally(()=>{
      setSyncStatus("ok");
      renderAll();
    });
}

/* =========================
   NAVEGA√á√ÉO
========================= */
function goPage(key){
  navItems.forEach(n=> n.classList.toggle("active", n.dataset.nav===key));
  Object.keys(pages).forEach(k=> pages[k].classList.toggle("active", k===key));

  const titles = {
    dashboard: ["Dashboard","Vis√£o geral das preventivas"],
    maquinas: ["M√°quinas","Cadastro e gest√£o de equipamentos"],
    tarefas: ["Tarefas","Cadastro, edi√ß√£o e controle"],
    relatorios: ["Relat√≥rios","Gera√ß√£o para impress√£o e CSV"]
  };
  pageTitle.textContent = titles[key]?.[0] || "Preventivas";
  pageSubtitle.textContent = titles[key]?.[1] || "";

  // atualizar pr√©via relat√≥rio ao entrar
  if(key==="relatorios") renderRelatorioPreview();
}
navItems.forEach(n=> n.addEventListener("click", ()=> goPage(n.dataset.nav)));

/* =========================
   M√ÅQUINAS (CRUD)
========================= */
function clearEqpForm(){
  selectedEqpId = null;
  eqNome.value = "";
  eqLocal.value = "";
  eqSerie.value = "";
  infoEqpSel.textContent = "Nenhuma m√°quina selecionada.";
  renderMaquinasList();
  renderEqpSelects();
  renderTabelas();
}

function setSelectedEqp(eqp){
  selectedEqpId = eqp?.id || null;
  if(!eqp){
    clearEqpForm();
    return;
  }
  eqNome.value = eqp.nome || "";
  eqLocal.value = eqp.local || "";
  eqSerie.value = eqp.serie || "";
  infoEqpSel.textContent = "Editando: " + (eqp.nome || "‚Äî");
  renderMaquinasList();
  renderEqpSelects();
  renderTabelas();
}

function addOrUpdateEquipamento(){
  const nome = (eqNome.value || "").trim();
  if(!nome){ toast("err","Campo obrigat√≥rio","Informe o nome da m√°quina."); return; }

  if(selectedEqpId){
    const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
    if(eqp){
      eqp.nome = nome;
      eqp.local = (eqLocal.value||"").trim();
      eqp.serie = (eqSerie.value||"").trim();
      fullSave();
      toast("ok","Salvo","M√°quina atualizada com sucesso.");
      setSelectedEqp(eqp);
    }
    return;
  }

  const eqp = {
    id: uid(),
    nome,
    local: (eqLocal.value||"").trim(),
    serie: (eqSerie.value||"").trim(),
    tarefas: []
  };
  store.equipamentos.push(eqp);
  selectedEqpId = eqp.id;
  fullSave();
  toast("ok","Salvo","M√°quina cadastrada com sucesso.");
  setSelectedEqp(eqp);
}

async function deleteEquipamento(eqpId){
  const eqp = store.equipamentos.find(e=> e.id===eqpId);
  if(!eqp) return;
  const ok = await confirmBox("Excluir m√°quina", `Excluir "${eqp.nome}" e todas as tarefas dela?`);
  if(!ok) return;

  store.equipamentos = store.equipamentos.filter(e=> e.id!==eqpId);
  if(selectedEqpId===eqpId) selectedEqpId=null;
  fullSave();
  toast("ok","Exclu√≠do","M√°quina removida.");
  renderAll();
}

function renderMaquinasList(){
  const q = (buscaEqp.value || "").trim().toLowerCase();
  const list = store.equipamentos
    .slice()
    .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""))
    .filter(e=> !q || `${e.nome} ${e.local||""} ${e.serie||""}`.toLowerCase().includes(q));

  listaEqp.innerHTML = "";
  countEqp.textContent = `${store.equipamentos.length} m√°quinas`;
  emptyEqp.style.display = store.equipamentos.length ? "none" : "block";

  list.forEach(eqp=>{
    const div = document.createElement("div");
    div.className = "item" + (eqp.id===selectedEqpId ? " active" : "");
    const sub = [eqp.local, eqp.serie].filter(Boolean).join(" ‚Ä¢ ");
    div.innerHTML = `
      <div>
        <b>${escapeHtml(eqp.nome||"‚Äî")}</b>
        <small>${escapeHtml(sub || "‚Äî")}</small>
      </div>
      <div class="actions">
        <button class="icon-btn danger" title="Excluir" data-del="${eqp.id}" type="button">üóë</button>
      </div>
    `;
    div.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(t instanceof HTMLElement && t.closest("[data-del]")) return;
      setSelectedEqp(eqp);
    });
    div.querySelector("[data-del]").addEventListener("click", (ev)=>{
      ev.stopPropagation();
      deleteEquipamento(eqp.id);
    });
    listaEqp.appendChild(div);
  });
}

function renderEqpSelects(){
  // select em tarefas
  selEqpTarefa.innerHTML = "";
  // select em relatorio
  repMaquina.innerHTML = "";

  const has = store.equipamentos.length > 0;

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = has ? "Selecione uma m√°quina‚Ä¶" : "Cadastre uma m√°quina primeiro";
  selEqpTarefa.appendChild(opt0);
  selEqpTarefa.disabled = !has;

  const optR0 = document.createElement("option");
  optR0.value = "";
  optR0.textContent = "Todas as m√°quinas";
  repMaquina.appendChild(optR0);

  store.equipamentos
    .slice()
    .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""))
    .forEach(e=>{
      const o = document.createElement("option");
      o.value = e.id;
      o.textContent = e.nome;
      selEqpTarefa.appendChild(o);

      const o2 = document.createElement("option");
      o2.value = e.id;
      o2.textContent = e.nome;
      repMaquina.appendChild(o2);
    });

  if(selectedEqpId && store.equipamentos.some(e=> e.id===selectedEqpId)){
    selEqpTarefa.value = selectedEqpId;
    const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
    hintEqpTarefa.textContent = buildEqpHint(eqp);
  }else{
    selEqpTarefa.value = "";
    hintEqpTarefa.textContent = "";
  }
}

function buildEqpHint(eqp){
  const parts = [];
  if(eqp.local) parts.push("Local: " + eqp.local);
  if(eqp.serie) parts.push("Patrim√¥nio/S√©rie: " + eqp.serie);
  return parts.join(" ‚Ä¢ ");
}

/* =========================
   TAREFAS (CRUD + EDIT SAVE)
========================= */
function clearTaskForm(){
  tkTitulo.value = "";
  tkPeriodo.value = "30";
  tkUltima.value = "";
  tkObs.value = "";
  editingTask = null;
  btnSalvarTarefa.textContent = "Adicionar";
  btnSalvarTarefa.classList.remove("warn");
  btnSalvarTarefa.classList.add("primary");
}

function setTaskModeEdit(){
  btnSalvarTarefa.textContent = "Salvar altera√ß√µes";
  btnSalvarTarefa.classList.remove("primary");
  btnSalvarTarefa.classList.add("warn");
}

function saveTask(){
  const eqpId = selEqpTarefa.value || "";
  if(!eqpId){ toast("err","Sele√ß√£o obrigat√≥ria","Selecione a m√°quina."); return; }
  const titulo = (tkTitulo.value||"").trim();
  if(!titulo){ toast("err","Campo obrigat√≥rio","Informe o t√≠tulo da tarefa."); return; }

  const periodo = parseInt(tkPeriodo.value,10) || 30;
  const ultimaISO = tkUltima.value || "";
  const obs = (tkObs.value||"").trim();

  const eqp = store.equipamentos.find(e=> e.id===eqpId);
  if(!eqp){ toast("err","Erro","M√°quina n√£o encontrada."); return; }
  if(!Array.isArray(eqp.tarefas)) eqp.tarefas = [];

  // EDITAR
  if(editingTask && editingTask.eqpId === eqpId){
    const tk = eqp.tarefas.find(t=> t.id===editingTask.tkId);
    if(!tk){
      toast("warn","Aviso","Tarefa n√£o encontrada. Vou voltar para adicionar.");
      clearTaskForm();
      return;
    }
    tk.titulo = titulo;
    tk.periodo = periodo;
    tk.ultimaISO = ultimaISO;
    tk.obs = obs;

    fullSave();
    toast("ok","Atualizado","Tarefa atualizada.");
    clearTaskForm();
    renderTabelas();
    return;
  }

  // ADICIONAR
  eqp.tarefas.push({
    id: uid(),
    titulo,
    periodo,
    ultimaISO,
    obs
  });

  fullSave();
  toast("ok","Salvo","Tarefa adicionada.");
  clearTaskForm();
  renderTabelas();
}

async function deleteTask(eqpId, tkId){
  const eqp = store.equipamentos.find(e=> e.id===eqpId);
  const tk = eqp?.tarefas?.find(t=> t.id===tkId);
  if(!eqp || !tk) return;

  const ok = await confirmBox("Excluir tarefa", `Excluir a tarefa "${tk.titulo}" da m√°quina "${eqp.nome}"?`);
  if(!ok) return;

  eqp.tarefas = eqp.tarefas.filter(t=> t.id!==tkId);
  fullSave();
  toast("ok","Exclu√≠do","Tarefa removida.");
  if(editingTask && editingTask.eqpId===eqpId && editingTask.tkId===tkId){
    clearTaskForm();
  }
  renderTabelas();
}

function markDoneToday(eqpId, tkId){
  const eqp = store.equipamentos.find(e=> e.id===eqpId);
  const tk = eqp?.tarefas?.find(t=> t.id===tkId);
  if(!eqp || !tk) return;

  tk.ultimaISO = todayISO();
  fullSave();
  toast("ok","Conclu√≠da","Marcada como feita hoje.");
  renderTabelas();
}

function editTask(eqpId, tkId){
  const eqp = store.equipamentos.find(e=> e.id===eqpId);
  const tk = eqp?.tarefas?.find(t=> t.id===tkId);
  if(!eqp || !tk) return;

  goPage("tarefas");
  selectedEqpId = eqp.id;
  renderEqpSelects();

  selEqpTarefa.value = eqp.id;
  hintEqpTarefa.textContent = buildEqpHint(eqp);

  tkTitulo.value = tk.titulo || "";
  tkPeriodo.value = String(tk.periodo || 30);
  tkUltima.value = tk.ultimaISO || "";
  tkObs.value = tk.obs || "";

  editingTask = { eqpId, tkId };
  setTaskModeEdit();
  window.scrollTo({top:0,behavior:"smooth"});
}

/* =========================
   ROWS (dados unificados)
========================= */
function buildRows(){
  const rows = [];
  store.equipamentos.forEach(eqp=>{
    (eqp.tarefas || []).forEach(tk=>{
      const nextISO = computeNext(tk.ultimaISO, tk.periodo);
      rows.push({
        eqpId:eqp.id,
        tkId:tk.id,
        equipamento:eqp.nome || "‚Äî",
        local:eqp.local || "",
        serie:eqp.serie || "",
        tarefa:tk.titulo || "‚Äî",
        periodo: tk.periodo || 30,
        ultima: tk.ultimaISO || "",
        proxima: nextISO,
        status: statusFor(nextISO),
        obs: tk.obs || ""
      });
    });
  });
  rows.sort((a,b)=> a.proxima.localeCompare(b.proxima));
  return rows;
}

/* =========================
   RENDER TABELAS / KPI
========================= */
function renderTabelas(){
  const rows = buildRows();

  // KPI
  const t = todayISO();
  const atr = rows.filter(r=> r.proxima < t).length;
  const ate7 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=7; }).length;
  const ate30 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=30; }).length;

  kpiAtr.textContent = atr;
  kpi7.textContent = ate7;
  kpi30.textContent = ate30;
  kpiTot.textContent = rows.length;
  kpiMeta.textContent = `${store.equipamentos.length} m√°quinas cadastradas`;

  // TABLE: tarefas (page tarefas)
  const q = (busca.value || "").trim().toLowerCase();
  const fil = selFiltro.value;

  const lista = rows.filter(r=>{
    const passBusca = !q || `${r.equipamento} ${r.tarefa} ${r.local} ${r.serie}`.toLowerCase().includes(q);
    let passFiltro = true;
    const d = diffDays(r.proxima, t);
    if(fil==="atrasadas") passFiltro = r.proxima < t;
    else if(fil==="sete") passFiltro = d>=0 && d<=7;
    else if(fil==="trinta") passFiltro = d>=0 && d<=30;
    return passBusca && passFiltro;
  });

  tbody.innerHTML = "";
  if(!lista.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">Nenhuma tarefa para o filtro atual.</td>`;
    tbody.appendChild(tr);
  }else{
    lista.forEach(r=>{
      const meta = [r.local, r.serie].filter(Boolean).join(" ‚Ä¢ ");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(r.equipamento)}</b><div class="muted">${escapeHtml(meta || "")}</div></td>
        <td>${escapeHtml(r.tarefa)}<div class="muted">${escapeHtml(r.obs || "")}</div></td>
        <td>${escapeHtml(String(r.periodo))}d</td>
        <td>${escapeHtml(fmtBR(r.ultima))}</td>
        <td>${escapeHtml(fmtBR(r.proxima))}</td>
        <td><span class="badge ${r.status.cls}">${escapeHtml(r.status.label)}</span></td>
        <td>
          <div class="row">
            <button class="ok" data-done="${r.eqpId}|${r.tkId}" type="button">Feita hoje</button>
            <button class="ghost" data-edit="${r.eqpId}|${r.tkId}" type="button">Editar</button>
            <button class="danger" data-del="${r.eqpId}|${r.tkId}" type="button">Excluir</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // TABLE: dashboard (top 20)
  renderDash(rows);

  // Relat√≥rio preview
  renderRelatorioPreview(rows);
}

function renderDash(rows){
  const t = todayISO();
  const mode = dashFiltro.value;
  let list = rows.slice();

  if(mode==="atrasadas") list = list.filter(r=> r.proxima < t);
  else if(mode==="sete") list = list.filter(r=> { const d=diffDays(r.proxima,t); return d>=0 && d<=7; });
  else if(mode==="trinta") list = list.filter(r=> { const d=diffDays(r.proxima,t); return d>=0 && d<=30; });

  list = list.slice(0,20);

  tbodyDash.innerHTML = "";
  if(!list.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="muted">Nenhuma tarefa para este filtro.</td>`;
    tbodyDash.appendChild(tr);
    return;
  }

  list.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(r.equipamento)}</b><div class="muted">${escapeHtml(r.local || "")}</div></td>
      <td>${escapeHtml(r.tarefa)}</td>
      <td>${escapeHtml(fmtBR(r.proxima))}</td>
      <td><span class="badge ${r.status.cls}">${escapeHtml(r.status.label)}</span></td>
      <td>
        <div class="row">
          <button class="ok" data-dashdone="${r.eqpId}|${r.tkId}" type="button">Feita hoje</button>
          <button class="ghost" data-dashedit="${r.eqpId}|${r.tkId}" type="button">Editar</button>
        </div>
      </td>
    `;
    tbodyDash.appendChild(tr);
  });
}

/* =========================
   RELAT√ìRIOS
========================= */
function filterForReport(rows){
  const t = todayISO();
  let list = rows ? rows.slice() : buildRows();

  const tipo = repFiltro.value;
  if(tipo==="atrasadas") list = list.filter(r=> r.proxima < t);
  else if(tipo==="sete") list = list.filter(r=> { const d=diffDays(r.proxima,t); return d>=0 && d<=7; });
  else if(tipo==="trinta") list = list.filter(r=> { const d=diffDays(r.proxima,t); return d>=0 && d<=30; });

  const loc = (repLocal.value||"").trim().toLowerCase();
  if(loc) list = list.filter(r=> (r.local||"").toLowerCase().includes(loc));

  const eqpId = repMaquina.value || "";
  if(eqpId){
    list = list.filter(r=> r.eqpId === eqpId);
  }

  list.sort((a,b)=> a.proxima.localeCompare(b.proxima));
  return list;
}

function renderRelatorioPreview(rows){
  const list = filterForReport(rows);
  repCount.textContent = `${list.length} itens`;

  tbodyRep.innerHTML = "";
  if(!list.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="muted">Nenhum item para o filtro do relat√≥rio.</td>`;
    tbodyRep.appendChild(tr);
    return;
  }

  list.slice(0,200).forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(r.equipamento)}</b></td>
      <td>${escapeHtml(r.local || "")}</td>
      <td>${escapeHtml(r.tarefa)}</td>
      <td>${escapeHtml(fmtBR(r.proxima))}</td>
      <td><span class="badge ${r.status.cls}">${escapeHtml(r.status.label)}</span></td>
    `;
    tbodyRep.appendChild(tr);
  });
}

function generateReportPrint(){
  const rows = filterForReport();
  const tipoTxt = repFiltro.options[repFiltro.selectedIndex]?.textContent || "‚Äî";
  const locTxt = (repLocal.value||"").trim();
  const eqpTxt = repMaquina.value ? (repMaquina.options[repMaquina.selectedIndex]?.textContent||"‚Äî") : "Todas";
  const now = new Date();

  const css = `
    body{font-family:Arial, sans-serif; margin:18px; color:#111;}
    h1{margin:0; font-size:18px;}
    .meta{margin-top:6px; color:#444; font-size:12px;}
    table{width:100%; border-collapse:collapse; margin-top:14px; font-size:12px;}
    th,td{border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top;}
    th{background:#f3f4f6;}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; font-weight:700; font-size:11px; border:1px solid #ddd;}
    .b-ok{background:#ecfdf5; color:#166534; border-color:#86efac;}
    .b-warn{background:#fffbeb; color:#92400e; border-color:#fde68a;}
    .b-err{background:#fef2f2; color:#991b1b; border-color:#fecaca;}
    @media print{button{display:none}}
  `;

  const trs = rows.map(r=>`
    <tr>
      <td><b>${escapeHtml(r.equipamento)}</b><div style="color:#666; font-size:11px">${escapeHtml([r.local,r.serie].filter(Boolean).join(" ‚Ä¢ "))}</div></td>
      <td>${escapeHtml(r.tarefa)}<div style="color:#666; font-size:11px">${escapeHtml(r.obs||"")}</div></td>
      <td>${escapeHtml(String(r.periodo))}d</td>
      <td>${escapeHtml(fmtBR(r.ultima))}</td>
      <td>${escapeHtml(fmtBR(r.proxima))}</td>
      <td><span class="badge ${r.status.cls}">${escapeHtml(r.status.label)}</span></td>
    </tr>
  `).join("");

  const html = `
    <!doctype html>
    <html><head><meta charset="utf-8"><title>Relat√≥rio Preventivas</title><style>${css}</style></head>
    <body>
      <h1>Relat√≥rio de Preventivas ‚Äî Grilazer</h1>
      <div class="meta">
        Gerado em: ${now.toLocaleString('pt-BR')}<br>
        Tipo: <b>${escapeHtml(tipoTxt)}</b><br>
        Local/Setor: <b>${escapeHtml(locTxt || "Todos")}</b><br>
        M√°quina: <b>${escapeHtml(eqpTxt)}</b><br>
        Total: <b>${rows.length}</b>
      </div>

      <table>
        <thead>
          <tr>
            <th>M√°quina</th>
            <th>Tarefa</th>
            <th>Per√≠odo</th>
            <th>√öltima</th>
            <th>Pr√≥xima</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>${trs || `<tr><td colspan="6">Nenhum item</td></tr>`}</tbody>
      </table>

      <script>window.print();</script>
    </body></html>
  `;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

function downloadCSV(){
  const rows = filterForReport();
  const header = ["Maquina","Local","Serie","Tarefa","PeriodoDias","Ultima","Proxima","Status","Obs"];
  const lines = rows.map(r=>[
    r.equipamento, r.local, r.serie, r.tarefa, r.periodo,
    r.ultima, r.proxima, r.status.label, (r.obs||"")
  ].map(v => `"${String(v??"").replaceAll('"','""')}"`).join(","));
  const csv = [header.join(","), ...lines].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `relatorio_preventivas_${todayISO()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ok","CSV gerado","Download iniciado.");
}

/* =========================
   EVENTOS TABELAS
========================= */
tbody.addEventListener("click", (ev)=>{
  const el = ev.target;
  if(!(el instanceof HTMLElement)) return;

  if(el.hasAttribute("data-done")){
    const [eqpId, tkId] = el.getAttribute("data-done").split("|");
    markDoneToday(eqpId, tkId);
  }else if(el.hasAttribute("data-edit")){
    const [eqpId, tkId] = el.getAttribute("data-edit").split("|");
    editTask(eqpId, tkId);
  }else if(el.hasAttribute("data-del")){
    const [eqpId, tkId] = el.getAttribute("data-del").split("|");
    deleteTask(eqpId, tkId);
  }
});

tbodyDash.addEventListener("click", (ev)=>{
  const el = ev.target;
  if(!(el instanceof HTMLElement)) return;

  if(el.hasAttribute("data-dashdone")){
    const [eqpId, tkId] = el.getAttribute("data-dashdone").split("|");
    markDoneToday(eqpId, tkId);
  }else if(el.hasAttribute("data-dashedit")){
    const [eqpId, tkId] = el.getAttribute("data-dashedit").split("|");
    editTask(eqpId, tkId);
  }
});

/* =========================
   RENDER GERAL
========================= */
function renderAll(){
  renderMaquinasList();
  renderEqpSelects();
  renderTabelas();
}

/* =========================
   INIT APP
========================= */
function initAppOnce(user){
  if(appInitialized) return;
  appInitialized = true;

  todaySpan.textContent = new Date().toLocaleDateString("pt-BR");
  userInfoSide.textContent = "Logado como: " + user.email;

  // online/offline indicator
  function updateNet(){
    netPill.textContent = navigator.onLine ? "Status: online" : "Status: offline";
    netPill.style.borderColor = navigator.onLine ? "rgba(22,163,74,.25)" : "rgba(245,158,11,.35)";
  }
  window.addEventListener("online", ()=>{ updateNet(); toast("ok","Online","Conex√£o restabelecida."); saveRemote(); });
  window.addEventListener("offline", ()=>{ updateNet(); toast("warn","Offline","Sem internet. Vou salvar localmente."); });
  updateNet();

  // load
  loadLocal();
  renderAll();
  syncFromFirebaseOnce();

  // nav
  goPage("dashboard");

  // maquinas
  btnNovoEqp.addEventListener("click", ()=>{ clearEqpForm(); toast("ok","Novo","Preencha os dados e salve."); });
  btnSalvarEqp.addEventListener("click", addOrUpdateEquipamento);
  btnLimparEqp.addEventListener("click", clearEqpForm);
  buscaEqp.addEventListener("input", renderMaquinasList);

  // tarefas
  selEqpTarefa.addEventListener("change", ()=>{
    selectedEqpId = selEqpTarefa.value || null;
    const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
    hintEqpTarefa.textContent = eqp ? buildEqpHint(eqp) : "";
    // trocar m√°quina cancela edi√ß√£o
    if(editingTask) clearTaskForm();
  });
  btnSalvarTarefa.addEventListener("click", saveTask);
  btnLimparTarefa.addEventListener("click", clearTaskForm);
  busca.addEventListener("input", renderTabelas);
  selFiltro.addEventListener("change", renderTabelas);

  // dashboard
  dashFiltro.addEventListener("change", renderTabelas);
  btnGoRelatorio.addEventListener("click", ()=>{ goPage("relatorios"); });

  // relatorios
  repFiltro.addEventListener("change", ()=> renderRelatorioPreview());
  repLocal.addEventListener("input", ()=> renderRelatorioPreview());
  repMaquina.addEventListener("change", ()=> renderRelatorioPreview());
  btnGerarRelatorio.addEventListener("click", generateReportPrint);
  btnBaixarCSV.addEventListener("click", downloadCSV);

  // misc
  btnPrintGlobal.addEventListener("click", ()=> window.print());
}

/* =========================
   LOGIN/AUTH
========================= */
function setLoginLoading(isLoading){
  btnLogin.disabled = isLoading;
  btnLogin.textContent = isLoading ? "Entrando..." : "Entrar";
}

function showLogin(){
  loginScreen.style.display = "flex";
  appShell.style.display = "none";
  loginError.textContent = "";
  loginSenha.value = "";
}

function showApp(){
  loginScreen.style.display = "none";
  appShell.style.display = "block";
}

auth.onAuthStateChanged(user=>{
  if(user && allowedEmails.includes(user.email)){
    showApp();
    initAppOnce(user);
  }else{
    if(user && !allowedEmails.includes(user.email)){
      auth.signOut();
    }
    showLogin();
  }
});

btnLogin.addEventListener("click", ()=>{
  const email = (loginEmail.value || "").trim();
  const senha = loginSenha.value || "";
  if(!email || !senha){
    loginError.textContent = "Preencha e-mail e senha.";
    return;
  }
  setLoginLoading(true);
  loginError.textContent = "";
  auth.signInWithEmailAndPassword(email, senha)
    .then(cred=>{
      const u = cred.user;
      if(!allowedEmails.includes(u.email)){
        auth.signOut();
        loginError.textContent = "Seu usu√°rio n√£o tem permiss√£o para acessar este painel.";
      }
    })
    .catch(err=>{
      console.error(err);
      loginError.textContent = "Login inv√°lido. Verifique e-mail e senha.";
    })
    .finally(()=> setLoginLoading(false));
});

btnLogout.addEventListener("click", ()=> auth.signOut());

// start
showLogin();
</script>

</body>
</html>
