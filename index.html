<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Preventivas de M√°quinas ‚Äî Grilazer (Admin)</title>

  <style>
    :root{
      --bg:#f3f5f8;
      --panel:#ffffff;
      --panel2:#fbfcfe;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --border2:#eef2f7;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;

      --shadow: 0 14px 35px rgba(15,23,42,.10);
      --shadow2: 0 10px 25px rgba(15,23,42,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.08), transparent 55%),
        linear-gradient(180deg, #f7f8fb, var(--bg));
      min-height:100dvh;
      padding:18px;
    }

    /* LOGIN */
    #login-screen{
      width:100%;
      min-height:calc(100dvh - 36px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .login-card{
      width:100%;
      max-width:420px;
      padding:18px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .login-card h1{margin:0;font-size:18px;font-weight:900}
    .login-card p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:700}
    .field input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .field input:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .btn{
      margin-top:8px;
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.65;cursor:wait}
    .login-error{margin-top:4px;font-size:12px;color:var(--err);min-height:14px}
    .login-foot{font-size:11px;color:var(--muted);margin-top:2px}

    /* APP */
    .wrap{width:100%;max-width:1200px;margin:0 auto}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fbfcff);
      box-shadow: var(--shadow2);
      margin-bottom:14px;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:260px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(37,99,235,.12), rgba(37,99,235,.03));
      display:grid;place-items:center;
      font-weight:1000;
      letter-spacing:.2px;
      color:#0b2a7a;
    }
    .brand h1{margin:0;font-size:16px;font-weight:950;line-height:1.1}
    #userInfoTop{font-size:11px;color:var(--muted);margin-top:4px}

    .controls{
      display:flex;flex-wrap:wrap;justify-content:flex-end;
      gap:8px;align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      border-radius:12px;
      padding:9px 11px;
      font-weight:900;
      cursor:pointer;
      color:var(--text);
      background: #fff;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    button:hover{border-color:#cbd5e1;box-shadow: 0 8px 18px rgba(15,23,42,.08)}
    button:active{transform: translateY(1px)}
    .ghost{background:#fff}
    .primary{
      color:#fff;
      border-color: rgba(37,99,235,.25);
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .ok{
      color:#fff;border-color: rgba(22,163,74,.25);
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    .warn{
      color:#fff;border-color: rgba(245,158,11,.25);
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    .err{
      color:#fff;border-color: rgba(239,68,68,.25);
      background: linear-gradient(135deg, #f87171, #ef4444);
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 380px 1fr;
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding:14px;
    }

    h3,h4{margin:0}
    h3{font-size:14px;font-weight:950}
    h4{font-size:13px;font-weight:900;color:var(--text);opacity:.95}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .sep{height:1px;background: var(--border2);margin:12px 0}

    label{
      display:block;
      font-weight:800;
      margin:10px 0 6px;
      color: rgba(15,23,42,.85);
      font-size:12px;
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:76px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #syncStatus{font-size:11px;color:var(--muted);margin-top:6px}

    /* TABS */
    .tabs{
      display:flex;
      gap:8px;
      border-bottom:1px solid var(--border2);
      padding-bottom:10px;
      margin-bottom:10px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:950;
      font-size:12px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .tab.active{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      color:#0b2a7a;
    }
    .pane{display:none}
    .pane.active{display:block}

    /* Lista m√°quinas */
    #listaEqp{
      margin-top:8px;
      max-height:280px;
      overflow:auto;
      padding-right:2px;
    }
    #listaEqp::-webkit-scrollbar{width:8px}
    #listaEqp::-webkit-scrollbar-thumb{background: rgba(15,23,42,.12);border-radius:999px}

    .chip-eqp{
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 10px;
      margin:8px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      font-size:12px;
      cursor:pointer;
      background: #fff;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
      gap:10px;
    }
    .chip-eqp:hover{background: #f8fafc; border-color:#cbd5e1}
    .chip-eqp:active{transform: translateY(1px)}
    .chip-eqp .title{font-weight:950}
    .chip-eqp .sub{color:var(--muted);margin-top:2px}
    .chip-eqp.active{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.35);
    }
    .chip-eqp button{
      padding:7px 10px;
      font-size:11px;
      border-radius:12px;
      white-space:nowrap;
      box-shadow:none;
    }
    .chip-eqp button:hover{box-shadow:none}

    /* Direita */
    .filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      background: #fff;
      border:1px solid var(--border);
      font-weight:900;
      font-size:11px;
      color: var(--muted);
    }

    .kpi{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      margin:10px 0 6px;
    }
    .kpi .card{
      padding:12px;
      border-radius:16px;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .kpi .big{
      font-size:22px;
      font-weight:1000;
      margin-top:4px;
      letter-spacing:.2px;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      margin-top:8px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th,.table td{
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:top;
      border-bottom:1px solid var(--border2);
    }
    .table th{
      background: #f8fafc;
      color: rgba(15,23,42,.75);
      font-size:12px;
      letter-spacing:.2px;
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{border-bottom:none}

    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:11px;
      letter-spacing:.2px;
      border:1px solid var(--border);
      background:#fff;
    }
    .b-ok{background: #ecfdf5; color:#166534; border-color:#86efac}
    .b-warn{background:#fffbeb; color:#92400e; border-color:#fde68a}
    .b-err{background:#fef2f2; color:#991b1b; border-color:#fecaca}

    .foot{
      margin-top:12px;
      color:rgba(100,116,139,.9);
      text-align:center;
      font-size:12px;
    }

    @media (max-width: 980px){
      body{padding:12px}
      .grid{grid-template-columns:1fr}
      .controls{justify-content:flex-start}
    }
    @media print{
      body{background:#fff;color:#000;padding:0}
      #login-screen{display:none !important}
      .controls{display:none !important}
      .card,.topbar{box-shadow:none !important}
      .table{background:#fff}
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>

  <!-- LOGIN -->
  <section id="login-screen">
    <div class="login-card">
      <h1>Preventivas ‚Äî Admin</h1>
      <p>Acesso restrito. Fa√ßa login com seu e-mail corporativo autorizado.</p>

      <div class="field">
        <label for="loginEmail">E-mail</label>
        <input type="email" id="loginEmail" autocomplete="email" placeholder="engenhariagrilazer@gmail.com">
      </div>

      <div class="field">
        <label for="loginSenha">Senha</label>
        <input type="password" id="loginSenha" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <button class="btn" id="btnLogin">Entrar</button>
      <div class="login-error" id="loginError"></div>

      <div class="login-foot">
        Usu√°rios v√°lidos s√£o gerenciados no Firebase Authentication (E-mail/Senha).
      </div>
    </div>
  </section>

  <!-- APP -->
  <div class="wrap" id="app-wrap" style="display:none">

    <div class="topbar">
      <div class="brand">
        <div class="logo">GR</div>
        <div>
          <h1>Preventivas de M√°quinas ‚Äî Grilazer</h1>
          <div id="userInfoTop"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ghost" id="btnNovoEqp" type="button">Novo</button>
        <button class="ghost" type="button" onclick="window.print()">Imprimir</button>
        <button class="ghost" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="grid">
      <!-- ESQUERDA (ABAS) -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabMaquinas" type="button">M√°quinas</button>
          <button class="tab" id="tabTarefas" type="button">Tarefas</button>
        </div>

        <!-- PANE M√ÅQUINAS -->
        <div class="pane active" id="paneMaquinas">
          <h3>Cadastro de M√°quina</h3>
          <div class="muted" id="infoEqpSel">Nenhuma m√°quina selecionada.</div>
          <div id="syncStatus">Sincroniza√ß√£o: carregando‚Ä¶</div>

          <label for="eqNome">Nome da m√°quina</label>
          <input id="eqNome" placeholder="Ex.: Prensa Hidr√°ulica 30T">

          <label for="eqLocal">Localiza√ß√£o</label>
          <input id="eqLocal" placeholder="Ex.: Metal√∫rgica, Setor A">

          <label for="eqSerie">N¬∫ de S√©rie / Patrim√¥nio</label>
          <input id="eqSerie" placeholder="Ex.: SER-000123 / PAT-045">

          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnSalvarEqp" type="button">Salvar</button>
            <button class="ghost" id="btnLimparEqp" type="button">Limpar</button>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h4>M√°quinas cadastradas</h4>
            <span class="muted">Clique para selecionar</span>
          </div>

          <div id="listaEqp"></div>
        </div>

        <!-- PANE TAREFAS -->
        <div class="pane" id="paneTarefas">
          <h3>Cadastro de Tarefa</h3>
          <div class="muted">Selecione a m√°quina e cadastre a tarefa</div>

          <label for="selEqpTarefa">M√°quina</label>
          <select id="selEqpTarefa"></select>
          <div class="muted" id="hintEqpTarefa" style="margin-top:6px"></div>

          <label for="tkTitulo">T√≠tulo da tarefa</label>
          <input id="tkTitulo" placeholder="Ex.: Lubrificar guias e mancais">

          <div class="row">
            <div style="flex:1;min-width:140px">
              <label for="tkPeriodo">Periodicidade</label>
              <select id="tkPeriodo">
                <option value="30">30 dias</option>
                <option value="90">90 dias</option>
                <option value="180">180 dias</option>
                <option value="360">360 dias</option>
              </select>
            </div>

            <div style="flex:1;min-width:140px">
              <label for="tkUltima">√öltima execu√ß√£o</label>
              <input id="tkUltima" type="date">
            </div>
          </div>

          <label for="tkObs">Observa√ß√µes</label>
          <textarea id="tkObs" placeholder="Materiais, torque, check-list, seguran√ßa, etc."></textarea>

          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnAddTarefa" type="button">Adicionar</button>
            <button class="ghost" id="btnLimparTarefa" type="button">Limpar</button>
          </div>

          <div class="muted" style="margin-top:6px">
            Dica: se nunca foi feita, deixe a √∫ltima execu√ß√£o em branco ‚Äî a pr√≥xima ser√° calculada a partir de hoje.
          </div>
        </div>
      </div>

      <!-- DIREITA (VIS√ÉO GERAL) -->
      <div class="card">
        <div class="filters">
          <input id="busca" placeholder="Buscar por m√°quina/tarefa‚Ä¶" style="flex:1;min-width:220px">
          <span class="pill">Hoje: <span id="today"></span></span>
          <select id="selFiltro">
            <option value="todos">Todos</option>
            <option value="atrasadas">Atrasadas</option>
            <option value="sete">Pr√≥x. 7 dias</option>
            <option value="trinta">Pr√≥x. 30 dias</option>
          </select>
        </div>

        <div class="kpi">
          <div class="card">
            <div class="muted">Atrasadas</div>
            <div class="big" id="kpiAtr">0</div>
          </div>
          <div class="card">
            <div class="muted">At√© 7 dias</div>
            <div class="big" id="kpi7">0</div>
          </div>
          <div class="card">
            <div class="muted">At√© 30 dias</div>
            <div class="big" id="kpi30">0</div>
          </div>
          <div class="card">
            <div class="muted">Total tarefas</div>
            <div class="big" id="kpiTot">0</div>
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>M√°quina</th>
              <th>Tarefa</th>
              <th>Per√≠odo</th>
              <th>√öltima</th>
              <th>Pr√≥xima</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="foot">Grilazer ‚Äî Preventivas</div>
  </div>

<script>
  // üîó CONFIG FIREBASE ‚Äì preventivas-27185
  const firebaseConfig = {
    apiKey: "AIzaSyDNrOyDmI5NOkVuG3yh8HkDrn4dqYXOrW0",
    authDomain: "preventivas-27185.firebaseapp.com",
    databaseURL: "https://preventivas-27185-default-rtdb.firebaseio.com",
    projectId: "preventivas-27185",
    storageBucket: "preventivas-27185.firebasestorage.app",
    messagingSenderId: "862235462324",
    appId: "1:862235462324:web:bcf4948b6b5bb96cbee5e1",
    measurementId: "G-8D16CFDLZV"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  const DB_PATH = "preventivas_grilazer";

  const allowedEmails = ["engenhariagrilazer@gmail.com"];

  // ===== LOGIN =====
  const loginScreen   = document.getElementById('login-screen');
  const appWrap       = document.getElementById('app-wrap');
  const loginEmail    = document.getElementById('loginEmail');
  const loginSenha    = document.getElementById('loginSenha');
  const btnLogin      = document.getElementById('btnLogin');
  const loginError    = document.getElementById('loginError');
  const btnLogout     = document.getElementById('btnLogout');
  const userInfoTop   = document.getElementById('userInfoTop');

  function setLoginLoading(isLoading){
    btnLogin.disabled = isLoading;
    btnLogin.textContent = isLoading ? "Entrando..." : "Entrar";
  }
  function showLogin(){
    loginScreen.style.display = "flex";
    appWrap.style.display     = "none";
    loginError.textContent    = "";
    loginSenha.value          = "";
  }
  function showApp(user){
    loginScreen.style.display = "none";
    appWrap.style.display     = "block";
    userInfoTop.textContent   = "Logado como: " + user.email;
  }

  // ===== APP =====
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const addDays = (iso, n)=>{
    const d = iso? new Date(iso) : new Date();
    d.setHours(12,0,0,0);
    d.setDate(d.getDate()+n);
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  };
  const diffDays = (a,b)=> Math.floor((new Date(a)-new Date(b))/(1000*60*60*24));
  const fmtBR = (iso)=> iso? new Date(iso+'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî';
  const uid = ()=> 'id-'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(4);

  let store = { equipamentos: [] };
  let selectedEqpId = null;
  let appInitialized = false;

  // ====== MODO EDI√á√ÉO DE TAREFA ======
  let editingTask = null; // { eqpId, tkId }
  let originalBtnAddText = null;

  // Tabs
  const tabMaquinas = document.getElementById('tabMaquinas');
  const tabTarefas  = document.getElementById('tabTarefas');
  const paneMaquinas = document.getElementById('paneMaquinas');
  const paneTarefas  = document.getElementById('paneTarefas');

  function openTab(which){
    const isM = which === 'maquinas';
    tabMaquinas.classList.toggle('active', isM);
    tabTarefas.classList.toggle('active', !isM);
    paneMaquinas.classList.toggle('active', isM);
    paneTarefas.classList.toggle('active', !isM);
  }

  // Elements
  const eqNome = document.getElementById('eqNome');
  const eqLocal = document.getElementById('eqLocal');
  const eqSerie = document.getElementById('eqSerie');
  const infoEqpSel = document.getElementById('infoEqpSel');
  const listaEqp = document.getElementById('listaEqp');
  const syncStatus = document.getElementById('syncStatus');

  const selEqpTarefa = document.getElementById('selEqpTarefa');
  const hintEqpTarefa = document.getElementById('hintEqpTarefa');

  const tkTitulo = document.getElementById('tkTitulo');
  const tkPeriodo = document.getElementById('tkPeriodo');
  const tkUltima = document.getElementById('tkUltima');
  const tkObs = document.getElementById('tkObs');

  const busca = document.getElementById('busca');
  const selFiltro = document.getElementById('selFiltro');
  const todaySpan = document.getElementById('today');

  const kpiAtr = document.getElementById('kpiAtr');
  const kpi7 = document.getElementById('kpi7');
  const kpi30 = document.getElementById('kpi30');
  const kpiTot = document.getElementById('kpiTot');
  const tbody = document.getElementById('tbody');

  const btnSalvarEqp = document.getElementById('btnSalvarEqp');
  const btnLimparEqp = document.getElementById('btnLimparEqp');
  const btnAddTarefa = document.getElementById('btnAddTarefa');
  const btnLimparTarefa = document.getElementById('btnLimparTarefa');
  const btnNovoEqp = document.getElementById('btnNovoEqp');

  function setSyncStatus(text){
    syncStatus.textContent = "Sincroniza√ß√£o: " + text;
  }

  function setTaskMode(isEdit){
    if(!originalBtnAddText) originalBtnAddText = btnAddTarefa.textContent || "Adicionar";
    if(isEdit){
      btnAddTarefa.textContent = "Salvar altera√ß√µes";
      btnAddTarefa.classList.add("warn");
      btnAddTarefa.classList.remove("primary");
    }else{
      btnAddTarefa.textContent = originalBtnAddText || "Adicionar";
      btnAddTarefa.classList.add("primary");
      btnAddTarefa.classList.remove("warn");
      editingTask = null;
    }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('preventivas');
      if(raw){ store = JSON.parse(raw); }
    }catch{}
  }
  function saveLocal(){
    try{ localStorage.setItem('preventivas', JSON.stringify(store)); }catch{}
  }
  function saveRemote(){
    setSyncStatus("enviando ao servidor‚Ä¶");
    db.ref(DB_PATH).set(store)
      .then(()=> setSyncStatus("ok (sincronizado)"))
      .catch(err=>{
        console.error(err);
        setSyncStatus("erro ao sincronizar (ver console)");
      });
  }
  function fullSave(){
    saveLocal();
    saveRemote();
  }

  function syncFromFirebaseOnce(){
    setSyncStatus("carregando do servidor‚Ä¶");
    db.ref(DB_PATH).once("value")
      .then(snapshot=>{
        const val = snapshot.val();
        if(val && Array.isArray(val.equipamentos)){
          store = val;
          saveLocal();
        }
      })
      .catch(err=>{
        console.error(err);
        setSyncStatus("erro ao carregar (usando dados locais)");
      })
      .finally(()=>{
        renderEqpList();
        renderEqpSelect();
        renderTabela();
        setSyncStatus("ok");
      });
  }

  function clearEqpForm(){
    selectedEqpId = null;
    eqNome.value  = '';
    eqLocal.value = '';
    eqSerie.value = '';
    infoEqpSel.textContent = 'Nenhuma m√°quina selecionada.';
    renderEqpList();
    renderEqpSelect();
    renderTabela();
  }

  function clearTaskForm(){
    tkTitulo.value  = '';
    tkPeriodo.value = '30';
    tkUltima.value  = '';
    tkObs.value     = '';
    setTaskMode(false); // volta para "Adicionar"
  }

  function setSelectedEqp(eqp){
    if(!eqp){
      clearEqpForm();
      return;
    }
    selectedEqpId = eqp.id;
    eqNome.value  = eqp.nome;
    eqLocal.value = eqp.local || '';
    eqSerie.value = eqp.serie || '';
    infoEqpSel.textContent = 'Editando: ' + eqp.nome;

    // sincroniza o SELECT da aba Tarefas
    selEqpTarefa.value = eqp.id;
    hintEqpTarefa.textContent =
      (eqp.local ? ("Local: " + eqp.local + " ‚Ä¢ ") : "") +
      (eqp.serie ? ("Patrim√¥nio/S√©rie: " + eqp.serie) : "");

    renderEqpList();
    renderTabela();
  }

  function renderEqpList(){
    listaEqp.innerHTML = '';
    if(!store.equipamentos.length){
      listaEqp.innerHTML = '<div class="muted">Nenhuma m√°quina cadastrada ainda.</div>';
      return;
    }

    store.equipamentos.forEach(eqp=>{
      const div = document.createElement('div');
      div.className = 'chip-eqp' + (eqp.id===selectedEqpId ? ' active' : '');

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="title">${eqp.nome}</div>
        <div class="sub">${(eqp.local||'')}${eqp.serie ? (' ‚Ä¢ ' + eqp.serie) : ''}</div>
      `;

      const btnDel = document.createElement('button');
      btnDel.className = 'err';
      btnDel.textContent = 'Excluir';
      btnDel.title = 'Excluir m√°quina';
      btnDel.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(confirm('Excluir m√°quina e todas as tarefas dela?')){
          store.equipamentos = store.equipamentos.filter(e=> e.id!==eqp.id);
          if(selectedEqpId===eqp.id) selectedEqpId=null;
          fullSave();
          renderEqpList();
          renderEqpSelect();
          renderTabela();
        }
      });

      div.appendChild(left);
      div.appendChild(btnDel);
      div.addEventListener('click', ()=> {
        setSelectedEqp(eqp);
        openTab('maquinas');
      });
      listaEqp.appendChild(div);
    });
  }

  function renderEqpSelect(){
    selEqpTarefa.innerHTML = '';
    if(!store.equipamentos.length){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Cadastre uma m√°quina primeiro';
      selEqpTarefa.appendChild(opt);
      selEqpTarefa.disabled = true;
      hintEqpTarefa.textContent = '';
      return;
    }

    selEqpTarefa.disabled = false;

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Selecione uma m√°quina‚Ä¶';
    selEqpTarefa.appendChild(placeholder);

    store.equipamentos.forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = e.nome;
      selEqpTarefa.appendChild(opt);
    });

    // manter sele√ß√£o se poss√≠vel
    if(selectedEqpId && store.equipamentos.some(e=> e.id===selectedEqpId)){
      selEqpTarefa.value = selectedEqpId;
      const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
      hintEqpTarefa.textContent =
        (eqp.local ? ("Local: " + eqp.local + " ‚Ä¢ ") : "") +
        (eqp.serie ? ("Patrim√¥nio/S√©rie: " + eqp.serie) : "");
    }else{
      selEqpTarefa.value = '';
      hintEqpTarefa.textContent = '';
    }
  }

  function addOrUpdateEquipamento(){
    const nome = eqNome.value.trim();
    if(!nome){ alert('Informe o nome da m√°quina'); return; }

    if(selectedEqpId){
      const eqp = store.equipamentos.find(e=> e.id===selectedEqpId);
      if(eqp){
        eqp.nome = nome;
        eqp.local = eqLocal.value.trim();
        eqp.serie = eqSerie.value.trim();
      }
    }else{
      const eqp = {
        id: uid(),
        nome,
        local: eqLocal.value.trim(),
        serie: eqSerie.value.trim(),
        tarefas: []
      };
      store.equipamentos.push(eqp);
      selectedEqpId = eqp.id;
    }

    fullSave();
    renderEqpList();
    renderEqpSelect();
    setSelectedEqp(store.equipamentos.find(e=> e.id===selectedEqpId));
  }

  // Adicionar OU Salvar edi√ß√£o
  function addTarefa(){
    const eqpIdSel = selEqpTarefa.value || '';
    if(!eqpIdSel){
      alert('Selecione a m√°quina para cadastrar a tarefa.');
      return;
    }

    const titulo = tkTitulo.value.trim();
    if(!titulo){
      alert('Informe o t√≠tulo da tarefa');
      return;
    }

    const periodo = parseInt(tkPeriodo.value,10) || 30;
    const ultimaISO = tkUltima.value || '';
    const obs = tkObs.value.trim();

    const eqp = store.equipamentos.find(e=> e.id===eqpIdSel);
    if(!eqp){
      alert('Erro: m√°quina n√£o encontrada.');
      return;
    }

    // ‚úÖ EDITAR
    if(editingTask && editingTask.eqpId === eqpIdSel){
      const tk = (eqp.tarefas||[]).find(t=> t.id === editingTask.tkId);
      if(!tk){
        alert('Erro: tarefa n√£o encontrada.');
        setTaskMode(false);
        return;
      }
      tk.titulo = titulo;
      tk.periodo = periodo;
      tk.ultimaISO = ultimaISO;
      tk.obs = obs;

      fullSave();
      renderTabela();
      clearTaskForm();
      alert('Tarefa atualizada!');
      return;
    }

    // ‚úÖ ADICIONAR
    eqp.tarefas.push({ id: uid(), titulo, periodo, ultimaISO, obs });

    fullSave();
    renderTabela();
    clearTaskForm();
  }

  function computeNext(ultimaISO, periodo){
    const base = ultimaISO || todayISO();
    return addDays(base, periodo);
  }
  function statusFor(nextISO){
    const t = todayISO();
    if(nextISO < t) return {label:'ATRASADA', cls:'b-err'};
    const d = diffDays(nextISO, t);
    if(d <= 7) return {label:'EM BREVE', cls:'b-warn'};
    return {label:'OK', cls:'b-ok'};
  }

  function renderTabela(){
    const rows = [];
    store.equipamentos.forEach(eqp=>{
      (eqp.tarefas||[]).forEach(tk=>{
        const nextISO = computeNext(tk.ultimaISO, tk.periodo);
        rows.push({
          eqpId:eqp.id,
          tkId:tk.id,
          equipamento:eqp.nome,
          tarefa:tk.titulo,
          periodo:tk.periodo,
          ultima:tk.ultimaISO || '',
          proxima:nextISO,
          status:statusFor(nextISO),
          local:eqp.local||'',
          serie:eqp.serie||'',
          obs:tk.obs||''
        });
      });
    });

    const t = todayISO();
    const atr = rows.filter(r=> r.proxima < t).length;
    const ate7 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=7; }).length;
    const ate30 = rows.filter(r=> { const d = diffDays(r.proxima, t); return d>=0 && d<=30; }).length;

    kpiAtr.textContent = atr;
    kpi7.textContent   = ate7;
    kpi30.textContent  = ate30;
    kpiTot.textContent = rows.length;

    const q = (busca.value || '').trim().toLowerCase();
    const fil = selFiltro.value;

    let lista = rows;

    lista = lista.filter(r=>{
      const passBusca = !q || `${r.equipamento} ${r.tarefa} ${r.local} ${r.serie}`.toLowerCase().includes(q);
      let passFiltro = true;
      const d = diffDays(r.proxima, t);
      if(fil==='atrasadas') passFiltro = r.proxima < t;
      else if(fil==='sete') passFiltro = d>=0 && d<=7;
      else if(fil==='trinta') passFiltro = d>=0 && d<=30;
      return passBusca && passFiltro;
    });

    lista.sort((a,b)=> a.proxima.localeCompare(b.proxima));

    tbody.innerHTML = '';
    if(!lista.length){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="7" class="muted">Nenhuma tarefa cadastrada para o filtro atual.</td>';
      tbody.appendChild(tr);
      return;
    }

    lista.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${r.equipamento}</b><div class="muted">${r.local||''} ${r.serie?('‚Ä¢ '+r.serie):''}</div></td>
        <td>${r.tarefa}<div class="muted">${r.obs||''}</div></td>
        <td>${r.periodo}d</td>
        <td>${fmtBR(r.ultima)}</td>
        <td>${fmtBR(r.proxima)}</td>
        <td><span class="badge ${r.status.cls}">${r.status.label}</span></td>
        <td>
          <div class="row">
            <button class="ok" data-done="${r.eqpId}|${r.tkId}" type="button">Feita hoje</button>
            <button class="ghost" data-edit="${r.eqpId}|${r.tkId}" type="button">Editar</button>
            <button class="err" data-del="${r.eqpId}|${r.tkId}" type="button">Excluir</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // A√ß√µes na tabela
  tbody.addEventListener('click', (ev)=>{
    const el = ev.target;
    if(!(el instanceof HTMLElement)) return;

    if(el.hasAttribute('data-done')){
      const [eqpId, tkId] = el.getAttribute('data-done').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      const tk = eqp?.tarefas.find(x=> x.id===tkId);
      if(tk){
        tk.ultimaISO = todayISO();
        fullSave();
        renderTabela();
      }
    }else if(el.hasAttribute('data-edit')){
      const [eqpId, tkId] = el.getAttribute('data-edit').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      const tk = eqp?.tarefas.find(x=> x.id===tkId);
      if(eqp && tk){
        // abre aba tarefas e preenche
        openTab('tarefas');

        selectedEqpId = eqp.id;
        renderEqpSelect();
        selEqpTarefa.value = eqp.id;
        hintEqpTarefa.textContent =
          (eqp.local ? ("Local: " + eqp.local + " ‚Ä¢ ") : "") +
          (eqp.serie ? ("Patrim√¥nio/S√©rie: " + eqp.serie) : "");

        tkTitulo.value  = tk.titulo;
        tkPeriodo.value = String(tk.periodo);
        tkUltima.value  = tk.ultimaISO || '';
        tkObs.value     = tk.obs || '';

        // ‚úÖ ativa modo edi√ß√£o
        editingTask = { eqpId, tkId };
        setTaskMode(true);

        window.scrollTo({top:0,behavior:'smooth'});
      }
    }else if(el.hasAttribute('data-del')){
      const [eqpId, tkId] = el.getAttribute('data-del').split('|');
      const eqp = store.equipamentos.find(e=> e.id===eqpId);
      if(!eqp) return;
      if(confirm('Excluir esta tarefa?')){
        eqp.tarefas = (eqp.tarefas||[]).filter(x=> x.id!==tkId);
        fullSave();
        renderTabela();
        // se estava editando essa tarefa, cancela modo edi√ß√£o
        if(editingTask && editingTask.eqpId===eqpId && editingTask.tkId===tkId){
          clearTaskForm();
        }
      }
    }
  });

  function initAppOnce(){
    if(appInitialized) return;
    appInitialized = true;

    todaySpan.textContent = new Date().toLocaleDateString('pt-BR');

    loadLocal();
    renderEqpList();
    renderEqpSelect();
    renderTabela();
    syncFromFirebaseOnce();

    // tabs
    tabMaquinas.addEventListener('click', ()=> openTab('maquinas'));
    tabTarefas.addEventListener('click', ()=> openTab('tarefas'));

    // sele√ß√£o via select (trocar m√°quina cancela edi√ß√£o)
    selEqpTarefa.addEventListener('change', ()=>{
      const id = selEqpTarefa.value;
      selectedEqpId = id || null;
      const eqp = store.equipamentos.find(e=> e.id===id);
      hintEqpTarefa.textContent = eqp
        ? ((eqp.local ? ("Local: " + eqp.local + " ‚Ä¢ ") : "") + (eqp.serie ? ("Patrim√¥nio/S√©rie: " + eqp.serie) : ""))
        : '';
      setTaskMode(false);
    });

    // bot√µes
    btnSalvarEqp.addEventListener('click', addOrUpdateEquipamento);
    btnLimparEqp.addEventListener('click', clearEqpForm);
    btnAddTarefa.addEventListener('click', addTarefa);
    btnLimparTarefa.addEventListener('click', clearTaskForm);
    btnNovoEqp.addEventListener('click', ()=>{
      clearEqpForm();
      clearTaskForm();
      openTab('maquinas');
    });

    // filtros
    busca.addEventListener('input', renderTabela);
    selFiltro.addEventListener('change', renderTabela);

    // garante estado inicial do bot√£o
    setTaskMode(false);
  }

  // ===== AUTH =====
  auth.onAuthStateChanged(user=>{
    if(user && allowedEmails.includes(user.email)){
      showApp(user);
      initAppOnce();
    }else{
      if(user && !allowedEmails.includes(user.email)){
        auth.signOut();
      }
      showLogin();
    }
  });

  btnLogin.addEventListener('click', ()=>{
    const email = loginEmail.value.trim();
    const senha = loginSenha.value;
    if(!email || !senha){
      loginError.textContent = "Preencha e-mail e senha.";
      return;
    }
    setLoginLoading(true);
    loginError.textContent = "";
    auth.signInWithEmailAndPassword(email, senha)
      .then(cred=>{
        const user = cred.user;
        if(!allowedEmails.includes(user.email)){
          auth.signOut();
          loginError.textContent = "Seu usu√°rio n√£o tem permiss√£o para acessar este painel.";
        }
      })
      .catch(err=>{
        console.error(err);
        loginError.textContent = "Login inv√°lido. Verifique e-mail e senha.";
      })
      .finally(()=> setLoginLoading(false));
  });

  btnLogout.addEventListener('click', ()=> auth.signOut());

  showLogin();
</script>

</body>
</html>
